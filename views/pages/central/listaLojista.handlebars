<!DOCTYPE html>
{{!-- ESSE FORM É A ADMINISTRAÇÂO CENTRAL DOS PRODUTOS --}}
{{!-- AQUI nós listamos os produtos,selecionamos fornecedores,editamos imagens,e importamos produtos --}}
<html lang="pt-br">
 <head>
    <meta http-equiv="Cache-Control" content="no-store" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">       
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css"> 
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/dashboard.css">
    <link rel="stylesheet" href="/js/empresa/produtoedit-imagem.js">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" defer></script>
    
    <script defer>
        window.colacerto = function () { }
    </script>
    <title>Rotaes  : Admin : lojista</title>
  <style>
      .cabecalho-tabela th {
        background-color: #f8f9fa;
        color: #333;
        padding: 10px;
        font-weight: 100;
        font-size: smaller;
      }
      table td{
        background-color: #068648;
      }

      .row{
        margin-bottom:5px;background-color: #d9c9c9;color: #0d0d0d;height: 5vh;font-weight: 100;
      }

      .row label {
        font-weight: 100;
        height: 2vh;
        padding-left: 10px;
      }

      .row input {
        font-weight: 600;
        height: 3vh;background-color: #f0f3f2;
      }

      .longa{
        width: 10vw;
        background-color: #068648;
      }



      .curta{
        width: 5vw;
        background-color: brown;
      }

      .ajusteRow{
        min-width: 100px; max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      }

</style>
 </head>

<script>
  let =jaCarregouDepartamentos=false;
  let selecionados = [];
</script>
<div id="corpo" style="width: 99vw;height: 96vh;margin: auto;background-color: #d0d3d0;">
    <div id="cadastroLojistaModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#bbbcbb80; justify-content:center; align-items:center; z-index:9999;padding: 5px;">
        <div style="background:#fff; width:50%; height:92vh;margin: auto;padding:10px; border-radius:10px; box-shadow:0 5px 10px #00000080;overflow-x: scroll;overflow-y: auto;">
            <h4 style="font-weight: 200;color: #141414;">Cadastro de Lojista</h4>
            <div id="divForm" style="background-color:transparent;height:90vh ;">
                <form id="cadastroLojistaForm" style="padding-left: 10px;width: 95%;margin: auto;background-color: #cc0b0b;">
                        <input type="hidden" id="editId" name="_id">
                        <div class="row">
                            <label>Razao:</label>
                            <input type="text" id="inputrazao" name="inputrazao" class="form-control">
                        </div>
                        <div class="row">
                            <label>Responsável:</label>
                            <input type="text" id="responsavel" name="responsavel" class="form-control">
                        </div>
                        <div class="row">
                            <label>CPF:</label>
                            <input type="text" id="cpf" name="cpf" class="form-control">
                        </div>
                        <div class="row">
                            <label>CNPJ:</label>
                            <input type="text" id="cnpj" name="cnpj" class="form-control">
                        </div>
                        <div class="row">
                            <label>Inscrição:</label>
                            <input type="text" id="inscricao" name="inscricao" class="form-control">
                        </div>
                        <div class="row">
                            <label>Site:</label>
                            <input type="text" id="site" name="site" class="form-control">
                        </div>
                        <div class="row">
                            <label>Marca:</label>
                            <input type="text" id="marca" name="marca" class="form-control">
                        </div>
                        <div class="row">
                            <label>Celular:</label>
                            <input type="text" id="celular" name="celular" class="form-control">
                        </div>
                        <div class="row">
                            <label>Fone:</label>
                            <input type="text" id="fone" name="fone" class="form-control">
                        </div>
                        <div class="row">
                            <label>Email:</label>
                            <input type="email" id="email" name="email" class="form-control">
                        </div>
                        <div class="row">
                            <label>Senha:</label>
                            <input type="password" id="senha" name="senha" class="form-control">
                        </div>
                        <div class="row">
                            <label>Cep:</label>
                            <input type="text" id="cep" name="cep" class="form-control">
                        </div>
                        <div class="row">
                            <label>Logradouro:</label>
                            <input type="text" id="logradouro" name="logradouro" class="form-control">
                        </div>
                        <div class="row">
                            <label>Complemento:</label>
                            <input type="text" id="complemento" name="complemento" class="form-control">
                        </div>
                        <div class="row">
                            <label>Bairro:</label>
                            <input type="text" id="bairro" name="bairro" class="form-control">
                        </div>
                        <div class="row">
                            <label>Cidade:</label>
                            <input type="text" id="cidade" name="cidade" class="form-control">
                        </div>
                        <div class="row">
                            <label>Estado:</label>
                            <input type="text" id="estado" name="estado" class="form-control" >
                        </div>
                        {{!-- ///////////////////////////////////////////////////////////////////////// --}}
                        <!-- Lista dos departamentos selecionados (pode ser antes visualmente) -->
                        <div class="row">
                              <label>Departameto selecionados:</label>
                          <div id="listaDepartamentosSelecionados" style="margin-bottom: 1vh;">
                              <input class="form-control" name="departamentos_nome[]" value="" readonly
                                  style="width: 20vw; height: 3.5vh;background-color: #bb048e;" />
                          </div>
                        </div>
                        <!-- Container onde cada linha select+input+ADD será inserida -->
                        <div class="row">

                        </div>
                        <div id="departamentoContainer" style="display: flex; flex-direction: column; gap: 4px; background-color: #068648; padding: 4px 1vw; width: 100%;">
                              <!-- Primeira linha de seleção -->
                              <div class="grupo-depto" style="display: flex; align-items: center; gap: 1vw;flex-direction: row;justify-content: space-between;">
                                      <!-- SELECT -->
                                      <select class="form-control select-departamento"
                                              name="departamentos[]"
                                              style="width: 15vw; height: 3.5vh; background-color: #ffffff; color: #db1212;">
                                        <option value="">Selecione um departamento</option>
                                      </select>
                                      <!-- INPUT readonly -->
                                      <!-- BOTÃO ADD -->
                                      <button type="button" class="btn btn-info btn-add-depto"
                                              style="padding: 2px 12px; font-size: medium;">ADD</button>
                              </div>
                        </div>
                        {{!-- ///////////////////////////////////////////////////////////////////////// --}}
                        <div class="row" style="height: 4vh;background-color:#0d0d0d ;margin-bottom: .5vh;margin-top: 4vh;">
                      
                        </div>
                        <div class="row" style="display:flex;flex-direction: row;justify-content:space-around;background-color: transparent;">
                            <button type="button" class="btn btn-secondary" style="width: 30%;" onclick="closeCadastroModal()">Cancelar</button>
                            <button type="submit" class="btn btn-primary" style="width: 30%;">Salvar</button>
                        </div>
                </form>
            </div>
        </div>
    </div>  
    <div id="listaLojista" class="" style="background-color:#fff;margin-top: 6vh;">
          <div style="display: flex;flex-direction: row;justify-content: center;">
          <button style="border: none;background-color:transparent;" class="btn btn-sm" onclick="openCadLojistaModal()">
            
            <h1 style="font-weight:200;color:#054288;font-size:medium">Cadastro de Lojista</h1>
          </button>
          </div>  
            <div id="barraSelect" style="display: flex;flex-direction: row;justify-content: space-between;width: 96vw;margin: auto;">
                <div style="background:transparent;width:32vw ;">
                  <h2 style="color: blue;">Lista de lojista</h2>
                </div>
               
            </div>
            <div style="background-color:#fff;width: 100%;height: 80vh;margin: auto;overflow: auto;padding: 4px;">
                    <div>
                      {{!-- {{lojista.segmentos}} --}}
                    </div>    
                    <table class="table table-bordered" spellcheck="false">
                          <thead>
                              <tr class="cabecalho-tabela">
                                  <th class="click-hide" data-column="0"><i data-lucide="eye-off"></i>Razão</th>
                                  {{!-- <th>Situação</th>
                                  <th>Template</th>
                                  <th>Atividade</th> --}}
                                  {{!-- <th>Resp.</th>
                                  <th>CPF</th> --}}
                                  <th class="click-hide" data-column="1"><i data-lucide="eye-off"></i>CNPJ</th>
                                  <th class="click-hide" data-column="2">Inscrição</th>
                                  <th class="click-hide" data-column="3">Site</th>
                                  <th class="click-hide" data-column="4">Marca</th>
                                  <th class="click-hide" data-column="5">Celular</th>
                                  <th class="click-hide" data-column="6">Fone</th>
                                  <th class="click-hide" data-column="7">Email</th>
                                  <th class="click-hide" data-column="8">Cep</th>
                                  <th class="click-hide" data-column="9">Logradouro</th>
                                  <th class="click-hide" data-column="9">Numero</th>
                                  <th class="click-hide" data-column="10">Complemento</th>
                                  <th class="click-hide" data-column="11">Cidade</th>
                                  <th class="click-hide" data-column="12">Bairro</th>
                                  <th class="click-hide" data-column="13">Estado</th>
                                  <th class="click-hide" data-column="14">Segmentos</th>
                                  <th class="click-hide" data-column="15">Status</th>
                                  <th class="click-hide" data-column="16">Ações</th>
                              </tr>
                          </thead>
                          <tbody>
                              {{#each lojista}}
                              <tr data-id="{{this._id}}">
                                  <td class="ajusteRow" contenteditable="true" data-field="razao">
                                      {{this.razao}}
                                  </td>
                                  <td class="ajusteRow" contenteditable="true" data-field="cnpj">{{this.cnpj}}</td>
                                  <td class="ajusteRow" contenteditable="true" data-field="inscricao">{{this.inscricao}}</td>
                                  <td class="ajusteRow" contenteditable="true" data-field="site">{{this.site}}</td>
                                  <td class="ajusteRow" contenteditable="true" data-field="marca">{{this.marca}}</td>
                                  <td class="ajusteRow" contenteditable="true" data-field="celular">{{this.celular}}</td>
                                  <td class="ajusteRow" contenteditable="true" data-field="telefone">{{this.telefone}}</td>
                                  <td class="ajusteRow" contenteditable="true" data-field="email">{{this.email}}</td>
                                  <td class="ajusteRow" contenteditable="true" data-field="cep">{{this.cep}}</td>
                                  <td class="ajusteRow" >{{this.logradouro}}</td>
                                  <td class="ajusteRow">{{this.numero}}</td>
                                  <td class="ajusteRow" >{{this.complemento}}</td>
                                  <td class="ajusteRow">{{this.cidade}}</td>
                                  <td class="ajusteRow">{{this.bairro}}</td>
                                  <td class="ajusteRow">{{this.estado}}</td>
                                  <td class="ajusteRow" style="color:#bb048e">
                                    {{#each departamentos}}
                                          <option value="{{this._id}}">{{this.nomeDepartamento}}</option>
                                    {{/each}}
                                  </td>
                                  <td>{{this.ativo}}</td>
                                  <td>
                                  <div class="d-flex justify-content-center align-items-center gap-2">
                                    <button id="show-all" class="save-line btn btn-sm btn-secondary flex-fill text-center" style="min-width: 80px;margin-left: 3px;background-color: #bb048e;border: 2px white solid;">
                                      <a href="" class="btn btn-sm flex-fill text-center" style="min-width: 80px;margin-left: 3px;border: 2px white solid;background-color: #bb048e;">All</a>
                                    </button>
                                    <button data-id="{{this._id}}"  class="btn btn-sm flex-fill text-center" style="min-width: 80px;margin-left: 3px;border: 2px white solid;background-color: coral;">
                                      {{!-- <a class="btn btn-sm flex-fill text-center" style="min-width: 80px;margin-left: 3px;border: 2px white solid;background-color: coral;">Editar</a> --}}
                                      <a href="/lojista/editar/{{this._id}}"
                                          class="btn btn-sm flex-fill text-center"
                                          style="min-width:80px;margin-left:3px;border:2px white solid;background-color:coral;">
                                          Editar
                                        </a>
                                    </button>
                                    
                                    <button data-id="{{this._id}}"  class="btn btn-sm btn-warning flex-fill text-center" style="min-width: 80px;margin-left: 3px;border: 2px white solid;background-color: #bb0404;">
                                      <a href="/lojistas/delete/{{this._id}}" class="btn btn-sm btn-danger flex-fill text-center" style="min-width: 80px;margin-left: 3px;border: 2px white solid">Excluir</a>
                                    </button>  
                                  </div>
                                  </td>
                              </tr>
                              {{/each}}
                          </tbody>
                    </table>
            </div>
            
    </div>
{{!-- ///////////////////////////////////////////////////////////////// --}}
</div>


<script>
  //lucide.createIcons();

    document.querySelectorAll(".click-hide").forEach(th => {
      th.addEventListener("click", (e) => {
        const columnIndex = parseInt(th.dataset.column);
        const table = th.closest("table");
        const icon = th.querySelector("svg");
        if (e.ctrlKey) {
          const rowsArray = Array.from(table.querySelectorAll("tbody tr"));
          rowsArray.sort((a, b) => {
            const valA = a.children[columnIndex].textContent.trim().toLowerCase();
            const valB = b.children[columnIndex].textContent.trim().toLowerCase();
            return valA.localeCompare(valB);
          });
          rowsArray.forEach(row => table.querySelector("tbody").appendChild(row));
        } else {
          table.querySelectorAll("tr").forEach(row => {
            if (row.children[columnIndex]) {
              row.children[columnIndex].classList.toggle("d-none");
            }
          });
          icon.setAttribute("data-lucide", icon.getAttribute("data-lucide") === "eye-off" ? "eye" : "eye-off");
          lucide.createIcons();
        }
      });
    });

    document.getElementById("show-all").addEventListener("click", () => {
      document.querySelectorAll("table tr").forEach(row => {
        Array.from(row.children).forEach(cell => {
          cell.classList.remove("d-none");
          cell.style.display = "";
        });
      });
      document.querySelectorAll(".click-hide svg").forEach(icon => {
        icon.setAttribute("data-lucide", "eye-off");
      });
      lucide.createIcons();
    });

    document.querySelectorAll("td[contenteditable=true]").forEach(cell => {
      cell.addEventListener("blur", async () => {
        const row = cell.closest("tr");
        const id = row.dataset.id;
        const field = cell.dataset.field;
        const value = cell.textContent.trim();
        try {
          console.log("Update lojista /:id",id)
          const response = await fetch(`/lojista/lojista/update/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ [field]: value })
          });
          const result = await response.json();
          if (response.ok) {
            cell.style.backgroundColor = "#c8f7c5";
            setTimeout(() => cell.style.backgroundColor = "", 1000);
          } else {
            alert("Erro ao atualizar.");
          }
        } catch (error) {
          console.error("Falha na atualização:", error);
          alert("Erro na comunicação.");
        }
      });
    });
</script>
{{!-- //</script> --}}
<script>
  document.querySelectorAll(".save-line").forEach(button => {
  button.addEventListener("click", async () => {
    const id = row.dataset.id;
    const row = row.closest("tr");
    const data = {};

    row.querySelectorAll("td[contenteditable=true]").forEach(cell => {
      data[cell.dataset.field] = cell.textContent.trim();
    });

    try {
      const response = await fetch(`/lojistas/update/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });

      const result = await response.json();
      if (response.ok) {
        row.style.backgroundColor = "#c8f7c5";
        setTimeout(() => row.style.backgroundColor = "", 1000);
      } else {
        alert("Erro ao atualizar.");
      }
    } catch (error) {
      console.error("Falha na atualização:", error);
      alert("Erro na comunicação.");
    }
  });
});


</script>
<script>
function  openCadLojistaModal() {
  openCadastroLojistaModal();
}
</script>
<script>
   function openCadastroLojistaModal(){
      //document.getElementById("cadastroLojistaModal").style.display="block";
       window.location.href = "/lojista/cadastro-cooperado";
   }  
</script>
{{!-- //XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX --}}
<script>
/* ===============================
   ROTINA 1: Variáveis globais
   Armazena os dados carregados do servidor e controle de estado
================================ */
let listaDepartamentos = [];

let jaCarregouDepartamentos = false;
let contador = 1; // controla a quantidade de departamentos adicionados
//++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
const maxDepartamentos = 10;
//const seleciXonados = [];
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("cadastroLojistaForm");
  if (!form) return;

  // preposições/conjunções que ficam minúsculas no meio
  const minusculas = new Set([
    'de','da','do','das','dos',
    'e','em','na','no','nas','nos',
    'por','para','com','sem','a','o','as','os'
  ]);

  function toTitleCaseSmart(str=''){
    return (str || '')
      .toLowerCase()
      .trim()
      .replace(/\s+/g,' ')
      .split(' ')
      .filter(Boolean)
      .map((p, idx) => {
        if (idx > 0 && minusculas.has(p)) return p;
        return p.charAt(0).toUpperCase() + p.slice(1);
      })
      .join(' ');
  }

   console.log(' [ 420 ]')
  // IDs/Names que NÃO serão formatados
  const ignorarIds = new Set(['cnpj','cpf']); // seus ids são exatamente esses
  const ignorarNames = new Set(['cnpj','cpf']);

  form.addEventListener("input", (e) => {
    const el = e.target;
    if (!el || el.tagName !== "INPUT") return;
    if (el.type !== "text") return;

    if (ignorarIds.has(el.id) || ignorarNames.has(el.name)) return;

    el.value = toTitleCaseSmart(el.value);
  });

  // se algum outro script quiser usar
  window.toTitleCaseSmart = toTitleCaseSmart;
});
</script>


<script>
(function () {
  console.log("[lojista] script carregou");

  // se o DOM já carregou, executa; senão espera
  function init() {
    const form = document.getElementById("cadastroLojistaForm");
    console.log("[lojista] form encontrado?", !!form);

    if (!form) return;

    const minusculas = new Set([
      "de","da","do","das","dos",
      "e","em","na","no","nas","nos",
      "por","para","com","sem","a","o","as","os"
    ]);

    function toTitleCaseSmart(str="") {
      return (str || "")
        .toLowerCase()
        .trim()
        .replace(/\s+/g, " ")
        .split(" ")
        .filter(Boolean)
        .map((p, idx) => (idx > 0 && minusculas.has(p))
          ? p
          : p.charAt(0).toUpperCase() + p.slice(1)
        )
        .join(" ");
    }

    form.addEventListener("input", (e) => {
      const el = e.target;
      if (!el || el.tagName !== "INPUT") return;
      if (el.type !== "text") return;

      // NÃO formatar CPF/CNPJ
      if (el.id === "cpf" || el.name === "cpf") return;
      if (el.id === "cnpj" || el.name === "cnpj") return;

      const before = el.value;
      el.value = toTitleCaseSmart(el.value);

      // debug mínimo
      if (before !== el.value) {
        console.log("[lojista] formatou:", el.id || el.name, "=>", el.value);
      }
    });

    console.log("[lojista] listener input instalado");
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", init);
  } else {
    init();
  }
})();
</script>


 