<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>{{ 'Sua revista eletrônica' }}</title>
          <link
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
          crossorigin="anonymous"
        />
        <!-- Font Awesome (opcional; pode ficar antes ou depois do Bootstrap) -->
        <link
          rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
          referrerpolicy="no-referrer"
        />
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Seu CSS por último para sobrescrever o Bootstrap -->
        <link rel="stylesheet" href="/css/home.css">
        
<style>

  /* ====== topo ====== */
.topbar{
  position: sticky; top:0; z-index:1000;
  background:#080808; color:#fff;
  box-shadow:0 2px 10px rgba(0,0,0,.15);
  font-size:clamp(14px,1.3vw,16px);
  margin-bottom: 12px; 
}

/*DETALHES*/
.topbar-row{
   display: grid;
  grid-template-columns: minmax(120px,1fr) minmax(420px,6fr) minmax(280px,3fr); /* <<< 1 / 6 / 3 */
  align-items: center;
  flex-wrap: wrap;
  gap: clamp(8px, 2vw, 16px);
  background:#d12b94;
}

/* ====== container centralizado (desktop e mobile) ====== */
.container-wide{
  width: 100%;                      /* <<< força 100% da viewport */
  max-width: none;                  /* <<< remove limite artificial */
  margin: auto;
  padding-left: clamp(16px, 3vw, 36px);
  padding-right: clamp(16px, 3vw, 36px);
  background: rgb(17, 17, 16);
  }

/* logo */
.brand{
  display:inline-flex; align-items:baseline; font-weight:800;
  font-size:clamp(18px,2vw,24px); color:#066bdf; text-decoration:none;
}

.brand-accent{ color: #ff4dc4; }           /* cor do "es" */

.actions{
  display:flex; align-items:center; justify-content:flex-end;
  gap: clamp(6px, 1vw, 12px);
  flex-wrap: nowrap;
  min-width: 300px;        /* <<< reserva justa p/ 3 pills */
  white-space: nowrap;
}

/*.actions{ justify-self: end; }*/

.action-link{
  color:#ecf3ff; text-decoration:none; font-weight:600;
  display:inline-flex; align-items:center; gap:6px;
  background: rgba(255,255,255,.08);
  border-radius: 999px; padding:4px 10px 4px 12px;   /* <<< menor */
  white-space: nowrap; font-size: clamp(12px,.95vw,14px); /* <<< menor */
}
.action-link:hover{ background:rgba(255,255,255,.15); }

.fa-cart-shopping{ font-size: 18px; }

/* ====== busca + filtros ====== */
.search-wrap{ display:flex; flex-direction:column; }

.search-wrap{ justify-self: stretch; }

.search-form{
  display:grid; gap:8px; align-items:center;
  grid-template-columns:
  minmax(440px, 1fr)  /* <- input cresce */
  minmax(120px, 14vw)
  minmax(120px, 14vw)
  auto;
  background: #04eadb;
  margin: 5px;
}

.search-form input.form-control{ min-width: 0; }  /* <<< NOVO */

.search-form .form-control,
.search-form .form-select{
   min-height: 40px;
  font-size: clamp(14px, 1.2vw, 16px);
  margin: 0;
}


.search-form .btn{
    min-height: 38px;
  font-size: clamp(13px, 1.1vw, 15px);
  padding: 6px 10px;                      /* <<< botão mais compacto */
  margin: 0;
  white-space: nowrap;
}
.search-form .form-control,.search-form .form-select{ border-color:#d0d0d0; };
.search-form > *{ min-width: 0; } 
.search-form input.form-control{ min-width: 0; }

/* se quiser esconder o botão sem quebrar o grid */
.search-form .btn[hidden]{ display:none !important; }
/* OU: temporariamente esconda visualmente mas preserve altura horizontal */
.hide-submit{ visibility:hidden; width:0; padding:0; margin:0; }




@media (min-width: 1200px){ .container{ max-width: 1320px; } }
@media (min-width: 1400px){ .container{ max-width: 1440px; } }
@media (max-width: 1100px){
  .topbar-row{
    grid-template-columns: 1fr;           /* tudo empilha */
    gap: 10px;
    text-align: center;
  }
  .brand{
    justify-self: center;
  }
  .search-form{
    grid-template-columns: 1fr 1fr;       /* duas colunas compactas */
  }
  .search-form .btn{
    grid-column: 1 / -1;                  /* botão ocupa linha toda */
  }
  .actions{
    justify-content: center;
    flex-wrap: wrap;
    gap: 6px;
  }
}


/* ====== responsivo ====== */
@media (max-width: 992px){
  .topbar-row {
    grid-template-columns: 1fr;
    gap: 10px;
  }
  .actions {
    justify-content: center;
    flex-wrap: wrap;
  }
  .search-form {
    grid-template-columns: 1fr 1fr;
  }
  .search-form .btn {
    grid-column: 1 / -1;
  }
}


@media (max-width: 576px){
  .topbar-row{ grid-template-columns: 1fr; gap: 6px; }
  .actions{ justify-content: center; }
  .brand{ justify-self: center; }
  .search-form{ grid-template-columns: 1fr; }
}

/* opcional: remove sombra/linhas da faixa abaixo se houver */
.header-shadow-bridge{ display:none; }


/* DEPOIS (alternativa segura) */
.topbar .container-wide{
  width:100%;
  max-width:none;
  margin:0;
  padding-left: clamp(16px, 3vw, 36px);
  padding-right: clamp(16px, 3vw, 36px);
}


@media (max-width:576px){
  /*.topbar .container-wide{ padding:0 12px; }*/
}
</style>
<style>
  .quickbar { padding-top: 0px; padding-bottom: 10px; } 
</style>
<style>
#sugestoesLista{
  position:absolute; top:100%; left:0; right:0;
  background:#fff; border:1px solid #cfcfcf; border-top:none;
  z-index: 1000; max-height: 240px; overflow:auto; display:none;
  box-shadow: 0 6px 16px rgba(0,0,0,.08);
}
#sugestoesLista .sug-item{
  padding:8px 10px; cursor:pointer; color:#900; /* seu vermelho */
  border-top:1px solid #eee;
  background:#fff;
}
#sugestoesLista .sug-item:hover,
#sugestoesLista .sug-item.active{
  background:#f6f6f6;
}
</style>
<style>
/* antes: aspect-ratio: 16 / 9; object-fit: cover;  */
/* garante espaço pro texto e evita sobreposição */
.atividade-name{
  margin-top: 6px;
  font-size: .95rem;
  font-weight: 600;
  color: #222;
  text-align: center;
}

@supports not (aspect-ratio: 1 / 1){
  .atividade-thumb{ position: relative; }
  .atividade-thumb::before{
    content: ""; display: block; padding-top: 100%; /* mantém quadrado */
  }
  .atividade-thumb img{
    position: absolute; inset: 8px;
    width: calc(100% - 16px);
    height: calc(100% - 16px);
    object-fit: contain;
  }
}
</style>
<style>
  .home-depto-bar{
  display:flex; gap:12px; flex-wrap:wrap;
}
.btn-depto{
  flex:1 1 160px;           /* ocupa largura; se tiver 1 só, expande a linha inteira */
  text-align:center;
  background:#5d87e6; color:#fff;
  border-radius:6px;  border:0;
  text-decoration:none; font-weight:600;
}
.btn-depto:hover{ filter:brightness(0.95); }
.btn-depto-active{ outline:2px solid #2b5dd1; }

.home-atividades .atividades-grid{
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(220px,1fr));
  gap:16px;
}
.atividade-card{
  display:block;
  border:1px solid #eee; border-radius:10px; padding:10px;
  text-decoration:none; color:#333; background:#fff;
  transition:transform .08s ease, box-shadow .08s ease;
}
.atividade-card:hover{ transform:translateY(-1px); box-shadow:0 6px 16px rgba(0,0,0,.08); }
.atividade-thumb{ height:130px; display:flex; align-items:center; justify-content:center; overflow:hidden; border-radius:8px; }
.atividade-thumb img{ width:100%; height:100%; object-fit:cover; }
.atividade-name{ margin-top:8px; text-align:center; font-weight:600; }

</style>
<style>
  .home-atividades { padding: 16px 0 24px; }
  .home-title { font-size: 1.25rem; font-weight: 600; margin: 8px 0 16px; }

  .atividades-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 16px;
  }

  .atividade-card {
    display: flex; flex-direction: column; gap: 8px;
    text-decoration: none; border: 1px solid #eee; border-radius: 12px;
    padding: 10px; background: #fff; transition: transform .12s ease, box-shadow .12s ease;
  }
  .atividade-card:hover { transform: translateY(-2px); box-shadow: 0 6px 18px rgba(0,0,0,.08); }

  .atividade-thumb {
    aspect-ratio: 16 / 9; width: 100%; overflow: hidden; border-radius: 10px; background: #f6f7f9;
    display: flex; align-items: center; justify-content: center;
  }
  .atividade-thumb img { width: 100%; height: 100%; object-fit: cover; display: block; }

  .atividade-name {
    font-size: .95rem; font-weight: 600; color: #222; text-align: center; min-height: 2.2em;
  }

  /* responsivo */
  @media (max-width: 768px) {
    .atividades-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; }
  }
</style>
<style>
.btn-depto-sub{
  display:inline-block;
  margin-top:6px;
  padding:6px 10px;
  font-size:.95rem;
  opacity:.9;
  pointer-events:none; /* apenas indicativo, não clicável */
}

/* cabeçalho do painel de seções */
.secoes-header{
  display:flex; align-items:center; gap:8px;
  margin-top: 4px;          /* encosta no topo */
  margin-bottom: 8px;       /* menos espaço antes do grid */
}

/* chips menores */
.btn-depto{ padding:4px 10px; font-size:.9rem; }
.btn-depto-sub{ padding:4px 10px; font-size:.9rem; margin-top:0; }

/* título com menos margem */
.home-title{ margin: 4px 0 8px; }
.card-product img { max-height: 220px; }
@media (min-width: 1200px){ .card-product img { max-height: 200px; } }
</style>
<style>
  .atividade-thumb{
  aspect-ratio: 1 / 1;
  width: 100%;
  overflow: hidden;
  border-radius: 10px;
  background: #f6f7f9;
  display: flex; align-items: center; justify-content: center;
}
.atividade-thumb img{
  width: 100%; height: 100%; object-fit: contain; display: block;
}

/* tipografia que acompanha a tela */
.topbar{ font-size: clamp(14px, 1.4vw, 16px); }
#vpLabel{
  position: fixed;
  top: 6px; right: 8px;
  z-index: 3000;
  background: rgba(0,0,0,.65);
  color: #fff;
  font: 600 12px/1.2 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
  padding: 4px 8px;
  border-radius: 6px;
  box-shadow: 0 2px 8px rgba(0,0,0,.15);
  pointer-events: none;     /* não intercepta cliques */
}
#vpLabel small{ opacity:.8; font-weight:500; }
.fa-cart-shopping{ font-size: 18px; }

#userMenu option { background:#b30000; color:#fff; }

</style>
<style>
  /* Mobile-first (até 575px) */
@media (max-width: 575.98px){
  .topbar-row{ grid-template-columns:1fr; text-align:center; }
  .search-form{ grid-template-columns:1fr; gap:10px; }
  .actions{ justify-content:center; flex-wrap:wrap; }
  .home-depto-bar{ gap:8px; }
  .atividade-thumb{ aspect-ratio: 1/1; }
}

/* ≥576px (sm) */
@media (min-width: 576px) and (max-width: 767.98px){
  .search-form{ grid-template-columns: 1fr 1fr; }
}

/* ≥768px (md) */
@media (min-width: 768px) and (max-width: 991.98px){
  .topbar-row{ grid-template-columns: 1fr 1fr; }
  .search-form{ grid-template-columns: 1fr 1fr 1fr; }
}

/* ≥992px (lg) */
@media (min-width: 992px) and (max-width: 1199.98px){
  .topbar-row{
    grid-template-columns: minmax(140px,1fr) minmax(420px,6fr) minmax(280px,3fr);
  }
}

/* ≥1200px (xl) — desktop “cheio” */
@media (min-width: 1200px){
  .topbar-row{
    grid-template-columns: minmax(120px,1fr) minmax(420px,6fr) minmax(280px,3fr);
  }
}

</style>
<style>
  

.produto-info-home {
  font-size: 0.8rem;
  line-height: 1.25;
  margin-top: 0.25rem;
  padding-top: 0.25rem;
  border-top: 1px solid #eee;
}

.produto-info-home p {
  margin: 0.1rem 0;
}

.produto-info-home strong {
  font-weight: 600;
}

/* links da loja */
.produto-info-home a {
  text-decoration: none;
  font-weight: 500;
}

.produto-info-home a:hover {
  text-decoration: underline;
}

/* botões */
.produto-info-home .btn {
  font-size: 0.75rem;
  padding: 0.15rem 0.55rem;
  margin-top: 0.25rem;
  margin-right: 0.25rem;
}

/* cada linha (Cód., À vista, Desc., Loja...) */
.pih-row {
  display: flex;
  gap: 4px;
  margin-bottom: 0.1rem;
}

/* “títulos” menores e suaves */
.pih-label {
  color: #666;
  font-weight: 500;
  min-width: 3.4rem; /* alinha as colunas */
}

/* valores */
.pih-value {
  color: #222;
}

/* descrição pode quebrar linha normal */
.pih-desc .pih-value {
  white-space: normal;
}

</style>
</head>
<body>
<header class="topbar">
  <div class="topbar-row container-wide" >
    <!-- LOGO -->
    <a class="brand" href="/">
      <span>Rota</span><span class="brand-accent">es</span>
    </a>
    <!-- BUSCA + FILTROS -->
    <form class="search-form" action="/buscar" method="get" autocomplete="off">
          <input class="form-control" name="q" id="inputBusca" placeholder="O que você procura?" autocomplete="off" />

          <select id="selectCidade" class="form-select" name="municipio">
              <option value="" {{#unless cidadeSelecionada}}selected{{/unless}}>Município</option>
              {{#each cidades}}
                <option value="{{this}}" {{#if (eq ../cidadeSelecionada this)}}selected{{/if}}>{{this}}</option>
              {{/each}}
          </select>
          <select id="selectBairro" class="form-select" name="loja">
            <option value="" {{#unless bairroSelecionado}}selected{{/unless}}>Bairros</option>
            {{#each bairros}}
              <option value="{{this}}" {{#if (eq ../bairroSelecionado this)}}selected{{/if}}>{{this}}</option>
            {{/each}}
          </select>
</form>
   <!-- AÇÕES -->
   <nav class="actions" style="background: #333;">
        {{#if userSite}}
            <div class="user-menu" style="display:inline-flex;align-items:center;gap:10px;">
                <i class="fa-regular fa-user" aria-hidden="true" style="margin-left:4px;margin-right:8px;"></i>
                <label for="userMenu" class="visually-hidden">Menu do usuário</label>

                <!-- select sem borda e com fundo da cor do botão -->
                <select id="userMenu" class="user-select"
                        onchange="if(this.value){ location.href=this.value; this.value=''; }"
                        style="background:transparent;color:#fff;border:none;border-radius:16px;
                              padding:4px 12px;height:28px;line-height:28px;font-size:.9rem;outline:none;">
                  <option value="" selected>{{firstName userSite.nome}}</option>
                  <option value="/home-logado">Minha conta</option>
                  <option value="/logout">Sair</option>
                </select>
            </div>
        {{else}}
           <a href="/login" class="action-link"><i class="fa-regular fa-user"></i> Login</a>
        {{/if}}
          <a href="/sejacooperado" class="action-link"><i class="fa-regular fa-id-badge"></i> Seja um cooperado</a>
    </nav>
  </div>
</header>
<label id="vpLabel" aria-live="polite"></label>
<div class="quickbar bg-light border-bottom" >
  <div class="container my-2">
      <div class="home-depto-bar" role="toolbar" aria-label="Departamentos" >
        {{#if departamentosAtivos.length}}
          {{#each departamentosAtivos}}
            {{!-- botão navega mudando ?segmento= --}}
            <a class="btn btn-depto {{#if (eq ../segmentoAtual this.nomeDepartamento)}}btn-depto-active{{/if}}"
              href="/?segmento={{encodeURIComponent this.nomeDepartamento}}">
              {{this.nomeDepartamento}}
            </a>
          {{/each}}
        {{else}}
          <div class="alert alert-warning m-0">Nenhum departamento ativado.</div>
        {{/if}}
      </div>
  </div>
</div>
<div id="Setores" style="display:block;">
  <section class="home-atividades">
    <div class="container">
      <h2 class="home-title">Setores</h2>
      {{#if atividades.length}}
        <div class="atividades-grid">
          {{#each atividades}}
              <a class="atividade-card js-open-setor"
                href="/setor/{{_id}}"
                data-setor-id="{{_id}}"
                aria-label="{{nome}}">
                <div class="atividade-thumb"><img src="{{imagemUrl}}" alt="{{nome}}"></div>
                <div class="atividade-name">{{titulo}}</div>
              </a>
          {{/each}}
        </div>
      {{else}}
        <p class="text-muted">Nenhum setor encontrado para {{segmentoAtual}}.</p>
      {{/if}}
    </div>
  </section>
</div>
<div id="secoesPane" class="container my-3" hidden></div>
<div id="produtos" class="container my-4" style="background-color: #fbfafa;display: none;">
        {{#if banner}}
            <div class="row mb-3">
              <div class="col">
                <img src="{{banner.url}}" alt="{{banner.alt}}" class="img-fluid rounded shadow-sm w-100">
              </div>
            </div>
        {{/if}}
        {{#if produtos.length}}
            <div class="row g-3" id="gridProdutos">
              {{#each produtos}}
                  <div class="col-12 col-sm-6 col-md-4 col-lg-3">
                    
                  </div>
              {{/each}}
            
              {{#each anuncios}}
              <div class="col-12 col-sm-6 col-md-4 col-lg-3">
                <aside class="card h-100 product-card d-flex align-items-center justify-content-center p-2 shadow-sm">
                  <img src="{{this.logo}}" alt="{{this.nome}}" class="img-fluid p-3" style="max-height:120px;">
                  <div class="card-body text-center">
                    <h6 class="mb-1">{{this.nome}}</h6>
                    <small class="text-muted">{{this.segmento}}</small>
                    <a href="{{this.url}}" class="btn btn-success w-100 mt-3">Ir</a>
                  </div>
                </aside>
              </div>
              {{/each}}
            </div>
        {{else}}
            <div class="alert alert-info">
                  Nenhum produto encontrado {{#if q}}para “{{q}}”{{/if}}.
                  <a href="/">Limpar filtros</a>
            </div>
        {{/if}}
</div>

<!-- linha anterior existente -->
{{!-- <script>
////////////////////////////////////////////////////////////
(function(){
  const el = document.getElementById('vpLabel') || (function(){
    const n = document.createElement('label'); n.id = 'vpLabel'; document.body.appendChild(n); return n;
  })();

  const fmt = n => String(n|0);
  function draw(){
    const w = window.innerWidth, h = window.innerHeight, dpr = window.devicePixelRatio || 1;
    el.innerHTML = `${fmt(w)}×${fmt(h)} <small>@${dpr.toFixed(2)}x</small>`;
  }

  let ticking = false;
  const raf = window.requestAnimationFrame || (fn=>setTimeout(fn,16));
  function onResize(){
    if (ticking) return;
    ticking = true; raf(()=>{ draw(); ticking = false; });
  }

  window.addEventListener('resize', onResize, {passive:true});
  window.addEventListener('orientationchange', onResize, {passive:true});
  window.addEventListener('load', draw, {once:true});
  draw();
})();
</script> --}}

{{!-- <script>
document.addEventListener('DOMContentLoaded', function(){
  var menu = document.getElementById('userMenu');
  if (!menu) return;
  console.log('menu X10',menu)
  //////////////////////////////////////////////////////////////
  function go(v){
    console.log('valor de v',v)
    if (v === 'logout') {
      window.location.href = '/logout';
    } else if (v === 'profile') {
      window.location.href = '/home-logado'; // ✅ com hífen
    }
    // volta a exibir o primeiro nome
    menu.value = '';
  }

  // dispara em troca real de opção
  menu.addEventListener('change', function(e){
    // log para confirmar que o handler está ativo
    console.log('[userMenu change]', e.target.value);
    go(e.target.value);
  });

  // fallback (alguns navegadores disparam 'input' ao abrir/confirmar)
  menu.addEventListener('input', function(e){
     console.log('[userMenu input]', e.target.value);
    if (e.target.value === 'logout' || e.target.value === 'profile') {
      go(e.target.value);
    }
  });
});
</script> --}}
</body>


</html>
<script id="home-bundle">
(() => {
  // ===== Helpers =====
  const $  = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
  const on = (el, ev, fn, op) => el && el.addEventListener(ev, fn, op);
  const escMap = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'};
  const esc = (x)=>String(x??'').replace(/[&<>\"']/g,m=>escMap[m]);
  const att = esc;
  const brl = v => (typeof v==='number' && isFinite(v) && v>0) ? v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}) : '';

  // ===== carregarBairros (global) =====
  async function carregarBairros(cidade, bairroSel='') {
    const selBairro = document.getElementById('selectBairro');
    if (!selBairro) return;
    if (!cidade){
      selBairro.innerHTML = '<option value="">Bairros</option>';
      selBairro.disabled = false;
      return;
    }
    selBairro.disabled = true;
    selBairro.innerHTML = '<option value="">Carregando...</option>';
    try{
      const r = await fetch(`/bairros?cidade=${encodeURIComponent(cidade)}`, { cache:'no-store' });
      const data = await r.json();
      const itens = Array.isArray(data) ? data : (Array.isArray(data?.items) ? data.items : []);
      selBairro.innerHTML =
        ['<option value="">Bairros</option>']
        .concat(itens.map(b => `<option value="${b}" ${b===bairroSel?'selected':''}>${b}</option>`))
        .join('');
    }catch(e){
      console.error('carregarBairros', e);
      selBairro.innerHTML = '<option value="">Bairros</option>';
    }finally{
      selBairro.disabled = false;
    }
  }
  window.carregarBairros = carregarBairros;

  // ===== Cidade/Bairro: regras de inicialização =====
  (async function initCidadeBairro(){
    const LOGGED = {{#if userSite}}true{{else}}false{{/if}};
    const PAD_CIDADE = `{{userSite.cidadePadrao}}` || '';
    const PAD_BAIRRO = `{{userSite.bairroPadrao}}` || '';
    const FROM_SERVER_CIDADE = `{{cidadeSelecionada}}` || '';
    const FROM_SERVER_BAIRRO = `{{bairroSelecionado}}` || '';

    const selCidade = document.getElementById('selectCidade');
    const selBairro = document.getElementById('selectBairro');
    if (!selCidade || !selBairro) return;

    // Fallback: se o servidor não trouxe lista de cidades (só placeholder), preenche localmente
    const DEFAULT_CIDADES = ['Vitória','Vila Velha','Serra','Cariacica','Guarapari'];
    if (selCidade.options.length <= 1) {
      DEFAULT_CIDADES.forEach(c => selCidade.add(new Option(c, c)));
    }

    // Helper para garantir opção presente e selecionada
    const ensure = (select, value) => {
      if (!value) return;
      let opt = Array.from(select.options).find(o => (o.value||'')===value);
      if (!opt){
        const idx = (select.options[0] && select.options[0].value==='') ? 1 : 0;
        opt = new Option(value, value, true, true);
        select.add(opt, idx);
      }
      select.value = value;
    };

    if (!LOGGED) {
      // Visitante e pós-logout: zera e limpa qualquer resquício salvo
      localStorage.removeItem('rotaes:cidade');
      localStorage.removeItem('rotaes:bairro');
      selCidade.selectedIndex = 0;                                 // "Município"
      selBairro.innerHTML = '<option value="">Bairros</option>';   // limpa bairros
      // ao mudar cidade, carrega bairros e não persiste nada
      on(selCidade, 'change', async () => {
        await carregarBairros(selCidade.value || '', '');
      });
      return; // nada de auto-preencher para visitante
    }

    // Logado: usa valor vindo do servidor (ou padrões do usuário)
    const useCidade = FROM_SERVER_CIDADE || PAD_CIDADE;
    const useBairro = FROM_SERVER_BAIRRO || PAD_BAIRRO;

    if (useCidade){
      ensure(selCidade, useCidade);
      await carregarBairros(useCidade, useBairro || '');
      if (useBairro) ensure(selBairro, useBairro);
      // opcional: persistir localmente enquanto logado
      localStorage.setItem('rotaes:cidade', useCidade);
      if (useBairro) localStorage.setItem('rotaes:bairro', useBairro);
    } else {
      // sem cidade conhecida → placeholders
      selCidade.selectedIndex = 0;
      selBairro.innerHTML = '<option value="">Bairros</option>';
    }

    // Mesmo logado, se trocar a cidade manualmente, recarrega bairros
    on(selCidade, 'change', e => carregarBairros(e.target.value, ''));
  })();

  // ===== Navegação: Setores -> Seções =====
  (function setoresSecoes(){
    const pane = document.getElementById('secoesPane');
    if (!pane) return;

    on(document, 'click', async (ev) => {
      const a = ev.target.closest('a.js-open-setor');
      if (!a) return;
      ev.preventDefault();
      const id = a.getAttribute('data-setor-id');
      if (!id) return;

      try{
        const r = await fetch(`/setor/${encodeURIComponent(id)}`, { headers:{'Accept':'application/json'} });
        if (!r.ok){ console.warn('API seções', r.status); return; }
        const data = await r.json();
        renderSecoes(data);
        showArea('secoes');
      }catch(e){ console.error(e); }
    });

    function card(s){
      return `
        <a class="atividade-card js-open-secao" href="${s.href}"
           data-secao-id="${att(s._id)}">
          <div class="atividade-thumb">
            <img loading="lazy" src="${s.imagemUrl}" alt="${att(s.nome)}">
          </div>
          <div class="atividade-name">${esc(s.nome)}</div>
        </a>`;
    }

    function renderSecoes(data){
      const header = `
        <div class="secoes-header">
          <div class="btn btn-depto btn-depto-active">${esc(data.departamento||'')}</div>
          <div class="btn btn-depto btn-depto-sub">${esc(data.setor||'')}</div>
        </div>
        <h2 class="home-title">Seções</h2>`;
      const grid = (Array.isArray(data.secoes) && data.secoes.length)
        ? `<div class="atividades-grid">${data.secoes.map(card).join('')}</div>`
        : `<p class="text-muted">Nenhuma seção com imagem neste setor.</p>`;
      pane.innerHTML = header + grid;
      pane.hidden = false;
      pane.scrollIntoView({behavior:'smooth', block:'start'});
    }
  })();

  // ===== Seção -> Produtos =====
  (function secaoProdutos(){
    on(document, 'click', async (ev) => {
      const a = ev.target.closest('a.js-open-secao');
      if (!a) return;
      ev.preventDefault();

      const secaoId = a.getAttribute('data-secao-id');
      if (!secaoId) return;

      try{
        const r = await fetch(`/secao/${encodeURIComponent(secaoId)}/produtos`, { headers:{'Accept':'application/json'} });
        if (!r.ok){ console.warn('API produtos da seção', r.status); return; }
        const data = await r.json(); // { secao, produtos }
        renderProdutos(data);
        showArea('produtos');
        document.getElementById('produtos')?.scrollIntoView({behavior:'smooth', block:'start'});
      }catch(e){ console.error(e); }
    });

    // alterna áreas
    window.showArea = function(area){
      const $ativ   = document.getElementById('Setores');
      const $secoes = document.getElementById('secoesPane');
      const $prod   = document.getElementById('produtos');
      if ($ativ)   $ativ.style.display   = 'none';
      if ($prod)   $prod.style.display   = 'none';
      if ($secoes){ $secoes.hidden = true; $secoes.style.display = 'none'; }
      if (area==='atividades' && $ativ) $ativ.style.display='block';
      else if (area==='secoes' && $secoes){ $secoes.hidden=false; $secoes.style.display='block'; }
      else if (area==='produtos' && $prod){ $prod.style.display='block'; }
    };
  })();

  // ===== Render de Produtos =====
  function renderProdutos(data){
    const $prod = document.getElementById('produtos');
    if (!$prod) return;
    console.log('6000', $prod)
    const nomeSecao = (data?.secao?.nomeSecao) || data?.secao || '';
    const prods = Array.isArray(data?.produtos) ? data.produtos : [];

    if (!prods.length){
      $prod.innerHTML = `<div class="text-center text-muted py-4">
        Nenhum produto encontrado para esta seção.
      </div>`;
      return;
    }

    const PLACEHOLDER = 'https://via.placeholder.com/480x360?text=Produto';
    const pickImage = (p) => {
      const arrays = [p.pageurlS, p.pageurls, p.pageurl, p.imagens, p.images];
      for (const a of arrays){ if (Array.isArray(a) && a.length && a[0]) return String(a[0]); }
      const singles = [p.imagemUrl, p.imageUrl, p.fotoUrl, p.thumbUrl];
      for (const s of singles){ if (s && String(s).trim()) return String(s).trim(); }
      return PLACEHOLDER;
    };

    const cards = prods.map(p => {
          const img        = pickImage(p);
          //const precoVista = p.precovista ? brl(p.precovista) : '';
          const raw =
              p.precovista && typeof p.precovista === 'object' && '$numberDecimal' in p.precovista
                ? p.precovista.$numberDecimal
                : p.precovista;

         let precoVista = '';

          if (raw !== undefined && raw !== null && raw !== '') {
            let num = Number(raw);

              if (!Number.isNaN(num)) {
                // se veio em centavos (ex: 17234) divide por 100
                // (assumindo que esse campo SEMPRE está em centavos)
                num = num / 100;

                precoVista = num.toLocaleString('pt-BR', {
                  minimumFractionDigits: 2,
                  maximumFractionDigits: 2
                });
              }
          }

          const href       = p.href || `/produto/${p._id}`;

          return `
            <div class="col-12 col-sm-6 col-md-4 col-lg-3 mb-3">
              <article class="card h-100 card-product">

                <a class="ratio ratio-4x3" href="${href}" aria-label="${esc(p.descricao||'')}">
                  <img class="w-100 h-100 object-fit-contain p-2"
                      src="${img}" alt="${esc(p.descricao || '')}" loading="lazy"
                      referrerpolicy="no-referrer"
                      onerror="this.src='${PLACEHOLDER}'">
                </a>

                <div class="card-body">
                  <h6 class="card-title mb-2 text-truncate" title="${esc(p.descricao || '')}">
                    ${esc(p.descricao || '')}
                  </h6>

                  <div class="produto-info-home">
                    <div class="pih-row">
                      <span class="pih-label">Cód.</span>
                      <span class="pih-value">${esc(p.codigo || '')}</span>
                    </div>

                    <div class="pih-row">
                      <span class="pih-label">À vista</span>
                      <span class="pih-value">
                        ${precoVista || 'sob consulta'}
                      </span>
                    </div>

                    <div class="pih-row pih-desc">
                      <span class="pih-label">Desc.</span>
                      <span class="pih-value">
                        ${esc(p.descricao || '')}
                        ${p.complete ? ' ' + esc(p.complete) : ''}
                      </span>
                    </div>

                    <div class="pih-row">
                      <span class="pih-label">Loja</span>
                      <span class="pih-value">
                        <a href="/loja/${p.loja_id || ''}">
                          ${esc(p.marcaloja || '')}
                        </a>
                      </span>
                    </div>

                    <div class="mt-1">
                      <a class="btn btn-sm btn-outline-primary"
                        href="/home-detalhe/${p._id}">
                        Detalhes / Conversar
                      </a>

                      <a class="btn btn-sm btn-outline-secondary"
                        href="/home-page-exclusiva/${p._id}"
                        target="_blank" rel="noopener">
                        Página exclusiva
                      </a>
                    </div>
                  </div>
                </div>

              </article>
            </div>
          `;
        }).join('');

    $prod.innerHTML = `
      <section class="container-fluid px-0">
          <div class="d-flex align-items-center justify-content-between mb-2 px-2">
            <h2 class="h6 mb-0">
              ${nomeSecao ? `Produtos · ${esc(nomeSecao)}` : 'Produtos'}
            </h2>
            <span class="text-muted small">${prods.length} itens</span>
          </div>

          <div class="row g-3 px-2">
            ${cards}
          </div>
     </section>`;
  }

})();
</script>
