<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">        
    <meta http-equiv="Cache-Control" content="no-store" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css"> 
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    {{!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"> --}}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    {{!-- <link rel="stylesheet" href="/css/fontawesome.min.css"> --}}
    <link rel="stylesheet" href="/css/dashboard.css">
    {{!-- <link rel="stylesheet" href="/js/empresa/cadastro.js"> --}}
    <link rel="stylesheet" href="/js/empresa/produtoEdit-imagem.js">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    {{!-- <script src='https://kit.fontawesome.com/a076d05399.js' crossorigin='anonymous'></script> --}}
    <script> src="https://"</script>
    <script defer>
      window.colacerto = function () { }
    </script>
    <title>Rotaes  : Admin : lojista</title>
    <style>
        * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      position: relative;
    }
   
    .foo{
      writing-mode: vertical-rl;
    }

    #main {
      width: 100vw;
      height: 100vh; /* altura para visualiza√ß√£o completa */
      background-color: #5e5c5c; /* apenas para visualiza√ß√£o */
      position: relative; /* necess√°rio para iniciar o contexto de empilhamento */
      z-index: 1; /* camada inferior */
    }

    #menuLateral {
      width: auto;
      height: 94vh;
      position: absolute;
      top: 3.8vh;
      left: 0;
      display: flex;
      flex-direction: row;
      z-index: 10;
      background-color: #fff;
    }

    #menulista {
       width: 13vw;
       height: 96vh;
       background-color:transparent;
       margin-top: 2px;
       transition: margin-left 0.4s ease;
       margin-left: -10vw; /* Escondido inicialmente */
    }

    #faixaVertical {
      width: 2vw;
      height: 96vh;
      background-color: #295ee4;
      z-index: 800;
      display: flex;
      flex-direction: column;
      justify-content: space-around;
    }

    #H2menuLateral {
      writing-mode: vertical-rl; /* vertical (de baixo para cima) */
      transform: rotate(180deg); /* inverte para cima para baixo */
      font-size: 1vw;
      color: #13e236;
      margin: 0;
      text-align: center;
      font-weight: 100;
      margin-left: .4vw;
    }

    .bck-flex{
      background-color:#ffffff;height: 100vh;
    }

    .grade{
      width:calc(100vw - 2.5vw);
      height: 95vh;
      background-color: #ffffff;
      margin:3.8vh 0px 0px 2.1vw;
      color:#295ee4
    }

    .edit-row {
      background-color: #f6990e; /* Amarelo claro */
    }

    .delete-row {
      background-color: #c40303; /* Vermelho claro */
    }

    .btn-warning{
       background-color: #b87004;
       color:#fff;
    }

    .btn-danger{
       background-color: #f90532;
       color:#fff;
    }

    .selected-row {
      background-color: unset;
    }

    
    </style>
    <style>
        /* Estilos gen√©ricos da tabela */
    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      background-color: #b80b0b;
       text-align:center;
    }


    td {
      border: 1px solid #ddd;
      padding-left: 8px;
      text-align:left;
    }

    
    button {
      cursor: pointer;
    }

    .openModal{
        display:block;
        position:fixed;
        top:0; left:0;
        width:100%; height:100%;
        background:#00000080;
        justify-content:center;
        align-items:flex-start;   /* cola no topo em notebook */
        padding-top:30px;         /* respiro no topo */
        z-index:9999;
  }
    </style>
    <style>
        #modalImagem.backdrop{
        position: relative;           /* vira painel normal */
        background: transparent;      /* sem fundo escuro */
        width: 47%;                   /* igual ao form */
        float: right;                 /* encosta √† direita */
        height: 97vh;                 /* mesmo ‚Äúp√©-direito‚Äù do form */
        display: block;
        z-index: auto;
        }

        #modalImagem.backdrop.show { display: block; }

        #modalImagem .mi-dialog{
        position: static;             /* sai do absolute */
        right: auto; top: auto;
        width: 100%;
        height: 97vh;                 /* acompanha o painel */
        /* mant√©m seu visual interno */
        background: #f10505;
        color: #fff;
        border-radius: 16px;
        box-shadow: 0 12px 40px rgba(0,0,0,.2); /* suaviza a sombra, opcional */
        overflow: hidden;
        display: flex;
        flex-direction: column;
        }


        /* ====== Cabe√ßalho (A) ====== */
        .mi-header {
        background: #8d0037; /* vinho */
        padding: 14px 18px 10px;
        display: grid;
        grid-template-columns: auto 1fr auto;
        gap: 12px;
        align-items: center;
        border-bottom: 2px solid #330018;
        }
        .mi-title {
        font-size: 20px;
        font-weight: 700;
        letter-spacing: .3px;
        white-space: nowrap;
        }
        .mi-actions { display: flex; gap: 10px; align-items: center; }
        .mi-btn {
        border: 0; outline: 0; cursor: pointer;
        padding: 8px 12px; border-radius: 10px;
        background: #1976d2; color: #fff; font-weight: 600;
        }
        .mi-btn:hover { filter: brightness(1.05); }
        .mi-btn.flat { background: #3949ab; }
        .mi-btn.danger { background: #b71c1c; }
        .mi-close {
        background: #111; color: #fff; border: 1px solid #333; border-radius: 12px;
        font-weight: 800; width: 36px; height: 36px; display: grid; place-items: center; cursor: pointer;
        }
        .mi-close:hover { background: #222; }


        /* ====== Linha de Informa√ß√µes (B) ====== */
        .mi-info {
        background: #19a204; /* verde vivo */
        padding: 10px 12px;
        border-bottom: 2px solid #0c5102;
        }
        .mi-grid {
        display: grid;
        grid-template-columns: 1.1fr 1.6fr 1.4fr 1.1fr;
        gap: 10px;
        }
        .mi-field { display: grid; gap: 4px; font-size: 12px; color: #122; }
        .mi-field label { font-weight: 700; color: #032d02; }
        .mi-field input {
        height: 34px; border: 0; border-radius: 8px;
        padding: 0 10px; outline: none; background: #fff; color: #000;
        }
        .mi-field input[readonly] { background: #f3f6f9; }


        /* ====== Corpo (C + D) ====== */

        /*.mi-body { flex: 1; display: grid; grid-template-rows: 220px 1fr; }  /* C ‚âà 220px, D ocupa o resto */
        .mi-body { flex:1; display:grid; grid-template-rows: 220px 1fr; } 

        /* ====== Se√ß√£o C: Slots de fotos ====== */
        .mi-slots {
        background: #ff066a; /* amarelo */
        padding: 14px 14px 8px;
        overflow: hidden;

        }

        .mi-slots-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .mi-slots-title { color: #1a1a1a; font-weight: 800; }
        .mi-nobank{
        margin:8px 0 0;
        background:rgba(176,0,32,.12);
        border:1px dashed #b00020;
        color:#2b0008;
        font-weight:800;
        padding:8px 10px;
        border-radius:10px;
        }
        .mi-slot-grid {
        display: grid; grid-template-columns: repeat(7, minmax(120px,1fr));
        gap: 12px; align-items: stretch;
        }
        .mi-slot {
        background: #ffffff; /* magenta */
        border-radius: 14px; position: relative; overflow: hidden; cursor: pointer;
        display: grid; place-items: center; min-height: 150px; border: 4px solid #ffe606;color:#0b100f;
        }

        .mi-slot::before{
        content: attr(data-num);
        position: absolute; top: 6px; left: 10px;
        font-weight: 900; font-size: 18px;
        color: #8d0037; text-shadow: 0 1px 0 #fff;
        }

        .mi-slot img { width: 100%; height: 100%; object-fit: cover; display: block; }

        .mi-slot.empty::after {
        content: "Clique aqui para pegar a foto no computador";
        color: #9c0808; font-weight: 400; text-align: center; padding: 10px; line-height: 1.1;
        }
        .mi-slot .mi-remove {
            position: absolute; top: 6px; right: 6px; width: 26px; height: 26px; border-radius: 50%;
            display: none; place-items: center; background: rgba(0,0,0,.65); color: #fff; font-size: 14px; cursor: pointer;
        }
        .mi-slot.filled .mi-remove { display: grid; }


        /* ====== Barra de a√ß√µes (slots) ====== */
        .mi-toolbar { display: flex; gap: 10px; }


        /* ====== Se√ß√£o D: Banco de Imagens ====== */
        .mi-bank {
            background: #7da56b; /* verde musgo claro do mock */
            border-top: 6px solid #8d0037; /* contorno vinho */
            padding: 10px 12px 12px;
            overflow: auto;
        }
        .mi-bank-title { font-weight: 800; color: #1b000a; margin-bottom: 8px; }
        .mi-bank-grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 10px; }
        .mi-thumb {
            aspect-ratio: 1/1; background: #f2f2f2; border-radius: 10px; overflow: hidden; border: 3px solid #7b002e; cursor: pointer;
            display: grid; place-items: center;
        }
        .mi-thumb img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .mi-empty-msg { opacity: .85; font-weight: 600; }

        /* ====== Rodap√© (gravar) ====== */
        .mi-footer {
        display:flex;
        align-items:center;
        justify-content:space-between;  /* deixa cada lado em sua ponta */
        padding:12px 16px;
        /* mantenha seu fundo atual se quiser */
        /* background:#0b0b0b; */
        overflow:visible;
        }

        .mi-footer-left{ position:relative; } 

        .mi-bankmenu{
        position:absolute;
        left:12px;             /* canto inferior esquerdo do modal */
        bottom:58px;
        display:none;
        background:#fff;
        padding:8px;
        border:1px solid #ddd;
        border-radius:10px;
        box-shadow:0 8px 18px rgba(0,0,0,.25);
        z-index:1600;
        gap:8px;
        flex-direction:column;
        }
        .mi-bankmenu.show{ display:flex; }
        .mi-btn.small{ padding:6px 10px; font-size:.85rem; }

        .mi-pop[hidden]{ display:none; }
        .mi-pop{
        position:absolute;
        left:0;  
        right:auto;                    /* gruda no bot√£o √† esquerda */
        bottom:56px;                 /* sobe acima da barra vermelha */
        z-index:50;
        display:flex;
        flex-direction:column;
        gap:8px;
        width: 200px;
        margin-left: 120px;
        }
        .mi-footer-left{ position:relative; }
        .mi-footer-right{ display:flex; gap:12px; }

        .mi-pop.show{ display:flex; }
        .mi-pop[hidden]{ display:none; }

        .mi-pop .mi-pop-item{
        border:0; background:#1166ba; border-radius:8px; padding:8px 10px;
        text-align:left; cursor:pointer; font-weight:300;margin-left: 2px;color:#ffffff;
        }
        .mi-pop .mi-pop-item:hover{ background:#0f4e8c; }
    </style>
    <style>
  .formata_{
    background:#959292; width:100%; height:97vh; padding:0px 6px 0px 6px; border-radius:10px; box-shadow:0 5px 10px #00000080;margin: auto;
  }

  .CidadeBairro{
    width: 70%;height: 3.2vh;margin: auto;
    margin-left: 6px;margin-top: -15px;
    background-color: #ffffff;
    color: #4e4d4d;
    text-align: center;
  }
    </style>
    <style>
      .duo {                 /* linha com 2 colunas */
            display: flex;
            gap: 12px;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        .duo .campo {         /* cada coluna */
            flex: 1;
            margin-bottom: 0;   /* j√° temos gap na linha */
        }
        .campo > label {
            display:block;
            margin: 2px 0 4px;
            font-weight: 700;
        }
        .campo .form-control {
            padding: 4px 8px;
            height: 32px;
            line-height: 30px;
        }
        /* empilha no mobile */
        @media (max-width: 768px){
            .duo { flex-direction: column; gap: 6px; }
        }

        .slot-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 6px;
  margin-top: 10px;
  background-color: transparent;
}

.slot {
  text-align: center;
}

.slot-box {
  border: 2px solid #ff0077;
  border-radius: 6px;
  padding: 4px;
  background-color: #ffff00;
  cursor: pointer;
  position: relative;
  min-height: 90px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

.slot-num {
  position: absolute;
  top: 2px;
  left: 4px;
  font-weight: bold;
  color: #d00;
}

.slot-label {
  font-size: 11px;
  line-height: 12px;
  color: #000;
}

.slot-preview {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 4px;
}

@media (max-width: 900px) {
  .slot-grid { grid-template-columns: repeat(3, 1fr); }
}
@media (max-width: 600px) {
  .slot-grid { grid-template-columns: repeat(2, 1fr); }
}

   
</style>
<style>
  .img-card--blocked { opacity:.35; pointer-events:none; position:relative; }
.img-card--blocked::after{
  content:"üö´";
  position:absolute; top:6px; right:6px; font-size:18px;
}
.img-badge{ position:absolute; bottom:6px; left:6px; background:#b30000; color:#fff; font-size:11px; padding:2px 6px; border-radius:4px;}

</style>
   
</head>
{{!-- /////////////////////////////////////////////////////////////////////////////// --}}
<body   style="background-color: #ffffff;">
    <div id="cadastroProdutoModal" class="" style="width: 50%;float: left;background-color: #848985;margin:auto;height:99vh ;">
        <div class="formata_">
            <button type="button" id="fecharForm" style="position: absolute;top: 5px;right: 5px;border: none;background: transparent;font-size: 30px;cursor: pointer;" onclick="closeCadastroModal()">&times;</button>
            <div style="width: 98%;height: 97vh;margin: auto;background-color: #000308;overflow-y: scroll ;margin-top: 1vh;padding: 5px;overflow-x: hidden;">
            <h4 style="font-weight: 200;color: #ffffff;">Edi√ß√£o de imagem</h4>
            <input type="hidden" name="produto_id" value="{{produtoId}}">
                <form id="cadastroProdutoForm" style="background-color: #021c03;color:#fff;position: relative;height: 120vh;" >
                    <div class="campo">
                        <label style="font-weight:bold;">Marca loja :</label>
                        <input value="{{produto.marcaloja}}" class="form-control fundo" readonly style="background: yellow;color:black">
                    </div>
                    <div class="campo" >
                        <label style="background-color:transparent;width: 110px;padding: 5px;font-weight:200;">Departamento :</label>
                        <input value="{{departamentoNome}}" class="form-control" readonly style="">
                    </div>
                    {{!-- ========================================================================== --}}
                    <div class="duo">
                            <div class="campo">
                                
                                <label style="background-color:transparent;width: 85px;padding: 5px;font-weight:200;">Setor:</label>
                                <input class="form-control" value="{{nsetor}}" style="background: yellow;color:black;height: 3vh;font-size: small;" readonly>
                            </div>
                            <div class="campo">
                                <label style="background-color:transparent;width: 85px;padding: 5px;font-weight:200;">Se√ß√£o:</label>
                                <input class="form-control" value="{{secaoNomes}}" style="background: yellow;color:black;height: 3vh;font-size: small;" readonly>
                            </div>
                    </div>

                    {{!-- <div class="campo">
                        <label style="font-weight:bold;">Setor:</label>
                        <input class="form-control" value="{setorNomes}}" style="background: yellow;color:black" readonly>
                     </div>
                    <div class="campo">
                        <label style="font-weight:bold;">Se√ß√£o:</label>
                        <input class="form-control fundo" value="{{secaoNomes}}" style="background: yellow;color:black" readonly>
                    </div> --}}
                    <div class="campo" >
                       <label style="background-color:transparent;width: 85px;padding: 5px;font-weight:200;">C√≥digo:</label>
                       <input id="cadastroCodigo" type="text" name="codigo" class="form-control fundo" style="background: yellow;color:black" value="{{produto.codigo}}" readonly>
                    </div>
                    <div class="campo" >
                       <label style="background-color:transparent;width: 85px;padding: 5px;font-weight:200;">Descri√ß√£o:</label>
                      <input id="cadastroDescricao" type="text" name="descricao" class="form-control fundo" value="{{produto.descricao}}" style="background: yellow;color:black" readonly>
                    </div>
                    <div class="campo" >
                       <label style="background-color:transparent;width: 85px;padding: 5px;font-weight:200;">Complemento:</label>
                      <input id="cadastroComplemento" type="text" name="complemento" class="form-control fundo" style="background: yellow;color:black;font-weight:200;" value="{{produto.complete}}" readonly>
                    </div>
                    <div class="campo">
                       <label style="background-color:transparent;width: 85px;padding: 5px;font-weight:200;">Refer√™ncia:</label>
                       <input id="cadastroReferencia" type="text" name="referencia" class="form-control fundo" style="background: yellow;color:black;font-weight:200;" value="{{produto.referencia}}" readonly>
                    </div>
                    <div class="campo">
                        <label style="background-color:transparent;width: 85px;padding: 5px;font-weight:200;">Fornecedor:</label>
                        <input class="form-control" value="{{fornecedorNome}}" style="background: yellow;color:black" readonly>
                    </div>
                    <div class="duo">
                        <div class="campo">
                                <label style="background-color:transparent;width: 85px;padding: 5px;font-weight: 200;">Cidade:</label>
                                <input class="form-control" value="{{produto.cidade}}" style="background: yellow;color:black;font-weight: 200;" readonly>
                            </div>
                            <div class="campo">
                                <label style="background-color:transparent;width: 85px;padding: 5px;font-weight:200;">Bairro:</label>
                                <input class="form-control" value="{{produto.bairro}}" style="background: yellow;color:black;font-weight: 200;" readonly>
                            </div>
                    </div>
                    <div class="campo">
                        <label style="background-color:transparent;width: 85px;padding: 5px;font-weight:200;">Quantidade:</label>
                        <input id="cadastroQte" type="number"  name="qte" class="form-control" style="background: yellow;color:black;font-weight: 200;" value="{{produto.qte}}">
                    </div>
                    <div class="campo">
                        <label style="background-color:transparent;width: 85px;padding: 5px;font-weight:200;">Pre√ßo Custo:</label>
                        <input id="cadastroPrecoCusto" type="number" name="precocusto" step="0.01" min="0" lang="pt-BR" style="background: yellow;color:black;font-weight: 200;"  class="form-control" value="{{produto.precocusto}}">
                    </div>
                    <div class="campo">
                        <label style="background-color:transparent;width: 85px;padding: 5px;font-weight:200;">Pre√ßo Vista:</label>
                        <input id="cadastroPrecoVista" type="number" name="precovista" step="0.01" min="0" lang="pt-BR" style="background: yellow;color:black;font-weight: 200;"  class="form-control" value="{{produto.precovista}}">
                    </div>
                    <div class="campo">
                        <label style="background-color:transparent;width: 100px;padding: 5px;font-weight:200;">Pre√ßo Prazo:</label>
                        <input id="cadastroPrecoPrazo" type="number" name="precoprazo" step="0.01" min="0" lang="pt-BR" style="background: yellow;color:black;font-weight: 200;"  class="form-control" value="{{produto.precoprazo}}">

                    </div>    
                    <div id="slotContainer" class="slot-grid">
                          {{#each slots}}
                            <div class="slot">
                              <div class="slot-box">
                                <span class="slot-num">{{n}}</span>

                                {{#if url}}
                                  <img class="slot-preview" src="{{url}}" alt="Imagem {{n}}">
                                {{else}}
                                  <div class="slot-empty" style="color:red">Sem imagem</div>
                                {{/if}}

                              </div>
                            </div>
                          {{/each}}
                    </div>
                    <div style="display: flex;flex-direction: row;justify-content:space-around;justify-items: center;padding: o 10px 0 10px;margin-bottom: 10px;">
                    </div>
                </form>
            </div>
        </div>
    </div> 
    <div id="modalImagem" class="backdrop" role="dialog" aria-modal="true" aria-hidden="true" style="width: 49.5%;float: left;background-color: #848985;margin:auto;height:99vh ;margin-right: 5px;">
      <div class="mi-dialog">
            <!-- A: Cabe√ßalho -->
            <div class="mi-header">
                <button id="miClose" class="mi-close" title="Fechar">√ó</button>
                <div class="mi-title">Tratando da imagem</div>
                <div class="mi-actions">
                <button id="miReloadBank" class="mi-btn flat" title="Recarregar banco de imagens">Recarregar Bco IMG</button>
                </div>
            </div>
            <!-- B: Linha de informa√ß√µes do produto -->
            <div class="mi-info">
                <div class="mi-grid">
                    <div class="mi-field">
                      <label>id-produto</label>
                      <input id="miProdId" type="text" readonly value="{{mi.id}}">
                    </div>
                    <div class="mi-field">
                      <label>descri√ß√£o</label>
                      <input id="miDescricao" type="text" readonly value="{{mi.descricao}}">
                    </div>
                    <div class="mi-field">
                      <label>fornecedor</label>
                      <input id="miFornecedor" type="text" readonly value="{{mi.fornecedor}}">
                    </div>
                    <div class="mi-field">
                      <label>departamento</label>
                      <input id="miDepartamento" type="text" readonly value="{{mi.departamento}}">
                    </div>
                </div>
            </div>
            <!-- Corpo: C (slots) + D (banco) -->
            <div class="mi-body">
                <!-- C: Slots de fotos -->
                <section class="mi-slots">
                  <div class="mi-slots-header">
                        <div class="mi-slots-title">Sele√ß√£o e Gravar Imagens</div>
                        <div class="mi-toolbar">
                          <button id="miClearAll" class="mi-btn danger">Limpar sele√ß√£o</button>
                        </div>
                  </div>
                  <div id="miSlotGrid" class="mi-slot-grid" style="background:transparent;"></div>
                  <div id="miNoBankBanner" class="mi-nobank" style="display:block">
                          N√£o h√° imagens no banco. Clique nas caixas acima para escolher do seu computador.
                  </div>
                  
                </section>
                <!-- D: Banco de imagens -->
                <section class="mi-bank">
                    <div class="mi-bank-title">banco de imagens</div>
                    <div id="imgbcoImg" name="imgbcoImg" class="mi-bank-grid"></div>
                    <div id="miBankEmpty" class="mi-empty-msg" style="display:none">
                        N√£o h√° imagens.
                    </div>
                </section>
            </div>
            <div class="mi-footer">
                  <div class="mi-footer-left">
                    <button id="miBankMenuBtn" class="mi-btn flat" type="button">Bco Imagem ‚ñæ</button>
                    <div id="miBankMenu" class="mi-pop" hidden>
                      <button id="miBankMenuDesc" class="mi-pop-item" type="button">Buscar por descri√ß√£o</button>
                      <button id="miBankMenuFor"  class="mi-pop-item" type="button">Buscar por fornecedor</button>
                    </div>
                  </div>

                  <div class="mi-footer-right">
                    <button id="btnGravarImagens" class="mi-btn primary" type="button">Gravar imagens</button>
                  </div>
            </div>
      </div>
   </div>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script> 
        <script src="https://code.jquery.com/jquery-3.7.1.min.js" crossorigin="anonymous"></script>
        <script src="/js/dashboard.js"></script>

        {{!-- <script src="/js/empresa/bcoimagem.js" defer></script> --}}
        {{!-- <script src="/js/empresa/produtoEdit-imagem.js" defer></script> --}}
        <script src="/js/rotinas/limpaSelect.js"></script>
        {{!-- <script src="/js/rotinas/produto-ImageModal.js"></script> --}}
        <script src="/js/rotinas/AcaoComDataset.js"></script>
  
{{!-- /////////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////
/**
 * Blocos de IMAGENS do produto ‚Äî migrados de cooperado-admin
 * Depende apenas de elementos opcionais no DOM:
 *  - #produtoId      (hidden com o _id do produto)
 *  - #file           (input[type=file])
 *  - #previewList    (container para pr√©vias locais)
 *  - #vinculadas     (container para imagens j√° vinculadas)
 *  - #btnBanco       (bot√£o para abrir o banco de imagens)
 *  - #btnSalvar      (bot√£o para gravar as imagens selecionadas)
 *
 * Obs.: Se voc√™ j√° tem fun√ß√µes globais (ex.: abrirModalBancoImagens,
 * uploadImagensProduto, listarImagensProduto, vincularImagemProduto),
 * este script as usa. Caso n√£o exista, ele faz um fallback simples.
 */ --}}
 <script>
  (() => {
  const $ = (sel) => document.querySelector(sel);
  const produtoIdEl   = $('#produtoId');
  const fileInput     = $('#file');
  const previewWrap   = $('#previewList');
  const vinculadasWrap= $('#vinculadas');
  const btnBanco      = $('#btnBanco');
  const btnSalvar     = $('#btnSalvar');

  const getProdutoId = () => produtoIdEl?.value?.trim() || '';

  const slotsRef = [
      document.getElementById('file1'),
      document.getElementById('file2'),
      document.getElementById('file3'),
      document.getElementById('file4'),
      document.getElementById('file5'),
      document.getElementById('file6'),
      document.getElementById('file7'),
   ];

    slotsRef.forEach((inp, idx) => {
      if (!inp) return;
      inp.addEventListener('change', (e) => {
        const f = e.target.files && e.target.files[0];
        if (f) {
          slots[idx] = { type: 'file', idx, file: f, filename: f.name };
        } else {
          // limpou o input
          if (slots[idx]?.type === 'file') delete slots[idx];
        }
      });
    });

  // ===== BLOCO 1 ‚Äì BUSCA NO COMPUTADOR (com filtro gen√©rico) --}}
  //if (fileInput) {
  //  fileInput.addEventListener('change', () => {
  //    if (!previewWrap) return;
  //    previewWrap.innerHTML = '';
  //    const files = Array.from(fileInput.files || []);
  //    files.forEach(f => {
  //      if (!/^image\//.test(f.type)) return;  // filtra s√≥ imagens
  //      const url = URL.createObjectURL(f);
  //      const img = document.createElement('img');
  //      img.src = url;
  //      img.alt = f.name;
  //      img.style.maxWidth = '110px';
  //      img.style.maxHeight = '110px';
  //      img.style.margin = '4px';
  //      previewWrap.appendChild(img);
  //    });
  //  });
  //}

  // ===== BLOCO 2 ‚Äì CARREGA AS IMAGENS J√Å VINCULADAS (por produto) + ABRIR MODAL --}}
  async function carregarImagensVinculadas() {
    return
    console.log('passando por carregaImagensVinculadas')
    if (!vinculadasWrap) return;
    vinculadasWrap.innerHTML = '<small>Carregando...</small>';

    const produtoId = getProdutoId();
    if (!produtoId) { vinculadasWrap.innerHTML = '<small>Produto sem ID.</small>'; return; }

    try {
      if (typeof window.listarImagensProduto === 'function') {
        // usa sua fun√ß√£o existente, se houver
        const lista = await window.listarImagensProduto(produtoId);
        renderVinculadas(lista);
      } else {
        // fallback simples ‚Äî ajuste a rota se necess√°rio
        const r = await fetch(`/gravafoto/produtoImagem/listar?produtoId=${encodeURIComponent(produtoId)}`);
        const json = await r.json();
        console.log(json)
        renderVinculadas(Array.isArray(json) ? json : (json.items || []));
      }
    } catch (e) {
      vinculadasWrap.innerHTML = '<small>Falha ao carregar imagens.</small>';
      console.error(e);
    }

    window.setSlotFromBank = function(idx, url, key){
  slots[idx] = { type: 'bank', idx, url, key: key || '' };
};
  }

  //  Se houver imagem vinculada com o produtoId ent√£o vamos criar os slots --}}
  function renderVinculadas(lista) {
    if (!vinculadasWrap) return;
    if (!lista?.length) { vinculadasWrap.innerHTML = '<small>Nenhuma imagem vinculada.</small>'; return; }
    vinculadasWrap.innerHTML = '';
    lista.forEach(it => {
      const img = document.createElement('img');
      img.src = it.url || it.imagemUrl || '';
      img.alt = it.nome || '';
      img.style.maxWidth = '110px';
      img.style.maxHeight = '110px';
      img.style.margin = '4px';
      vinculadasWrap.appendChild(img);
    });
  }

  // ===== BLOCO 3 ‚Äì BUSCA NO BANCO DE IMAGENS --}}
  if (btnBanco) {
    btnBanco.addEventListener('click', () => {
      // Se voc√™ j√° tem um modal/fun√ß√£o, usa:
      if (typeof window.abrirModalBancoImagens === 'function') {
        window.abrirModalBancoImagens(getProdutoId());
      } else {
        // fallback m√≠nimo: emite um evento para quem escuta abrir o modal
        document.dispatchEvent(new CustomEvent('abrir-banco-imagens', {
          detail: { produtoId: getProdutoId() }
        }));
      }
    });
  }

  // ===== BLOCO 4 ‚Äì Gravar imagens (usa suas fun√ß√µes existentes) --}}
  if (btnGravar) {
    btnGravar.addEventListener('click', async () => {
      alert("ATEN√á√ÉO!!")
      //console.log('getProduto_Id',getProdutoId) --}}
      //const produtoId = getProdutoId();
      //if (!produtoId) { alert('Produto sem ID.'); return; }
      const files = Array.from(fileInput?.files || []);
      if (!files.length) { alert('Selecione ao menos uma imagem.'); return; }

      try {
        if (typeof window.uploadImagensProduto === 'function') {
          // usa seu fluxo atual (ex.: Spaces + vincular)
          await window.uploadImagensProduto(files, produtoId);
        } else {
          // fallback simples ‚Äî ajuste a rota se necess√°rio --}}
          const fd = new FormData();
          fd.append('produtoId', produtoId);
          files.forEach(f => fd.append('imagens', f));
          await fetch('/gravafoto/upload', { method: 'POST', body: fd });
        }
        // recarrega a galeria vinculada --}}
        await carregarImagensVinculadas();

        // limpa sele√ß√£o local --}}
        if (fileInput) { fileInput.value = ''; }
        if (previewWrap) { previewWrap.innerHTML = ''; }
        alert('Imagens gravadas.');
      } catch (e) {
            console.error(e);
            alert('Falha ao gravar imagens.');
      }
    });
  }

  // Carrega as vinculadas assim que a p√°gina do cadastro abrir --}}
  document.addEventListener('DOMContentLoaded', carregarImagensVinculadas);
})();
</script>
   
</body>
</html>



{{!-- MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM --}}
<script>
/* INIT ‚Äî refer√™ncias do modal de imagem, vis√≠veis para os demais scripts */
(() => {
  window.$backdrop       = document.getElementById('modalImagem');
  window.$miSlotGrid     = document.getElementById('miSlotGrid');
  window.$miBankGrid     = document.getElementById('imgbcoImg');
  window.$miBankEmpty    = document.getElementById('miBankEmpty');
  window.$miNoBankBanner = document.getElementById('miNoBankBanner');
  window.$miSlotsTitle   = document.querySelector('.mi-slots-title');

  window.$miProdId       = document.getElementById('miProdId');
  window.$miDescricao    = document.getElementById('miDescricao');
  window.$miFornecedor   = document.getElementById('miFornecedor');
  window.$miDepartamento = document.getElementById('miDepartamento');

  window.$hiddenFile     = document.getElementById('miHiddenFile');
  window.$miReloadBank   = document.getElementById('miReloadBank');
  window.$miClearAll     = document.getElementById('miClearAll');
  window.$miClose        = document.getElementById('miClose');
  window.$btnGravar      = document.getElementById('btnGravarImagens');

  // --- menu do banco de imagens ---
  window.$miBankMenuBtn  = document.getElementById('miBankMenuBtn');
  window.$miBankMenu     = document.getElementById('miBankMenu');
  window.$miBankMenuDesc = document.getElementById('miBankMenuDesc');
  window.$miBankMenuFor  = document.getElementById('miBankMenuFor');

  // --- stubs seguros (caso os blocos de fun√ß√µes carreguem depois) ---
  window.setBankEmptyState = window.setBankEmptyState || function(flag){
    if (window.$miBankEmpty)    $miBankEmpty.style.display    = flag ? 'block' : 'none';
    if (window.$miNoBankBanner) $miNoBankBanner.style.display = flag ? 'block' : 'none';
    if (window.$miSlotsTitle)   $miSlotsTitle.textContent = flag
      ? 'Nenhuma imagem no banco ‚Äî clique nas caixas acima para buscar no computador'
      : 'Sele√ß√£o e Gravar Imagens';
  };

  window.clearBankUI = window.clearBankUI || function(showMsg = true){
    if (window.$miBankGrid) $miBankGrid.innerHTML = '';
    setBankEmptyState(!!showMsg);
  };
})();

</script>
<script>
(() => {
        const $  = (s) => document.querySelector(s);
        const $$ = (s) => Array.from(document.querySelectorAll(s));

        // ===== elementos do seu modal =====
        const elProdId   = $('#miProdId');
        const elSlots    = $('#miSlotGrid');
        const elBankGrid = $('#imgbcoImg');
        const elBankEmpty= $('#miBankEmpty');

        const btnReloadBank = $('#miReloadBank');
        const btnBankMenu   = $('#miBankMenuBtn');
        const btnBankByDesc = $('#miBankMenuDesc');
        const btnBankByFor  = $('#miBankMenuFor');
        const btnGravar     = $('#btnGravarImagens');

        const getProdutoId = () => (elProdId?.value || '').trim();

        // ===== carregar banco de imagens (filtro opcional) =====
        async function carregarBancoImagens(filtro = {}) {
              if (!elBankGrid) return;

              elBankGrid.innerHTML = '<small>Carregando...</small>';
              elBankEmpty?.setAttribute('style','display:none');

          try {
                  if (typeof window.listarBancoImagens === 'function') {
                    // usa sua fun√ß√£o, se existir
                    const itens = await window.listarBancoImagens(filtro);
                    renderBanco(itens);
                  } else {
                    // fallback simples ‚Äî ajuste a rota conforme seu backend
                    const qs = new URLSearchParams(filtro).toString();
                    
                    const r  = await fetch('/gravafoto/produtoImagem/buscar/:termo' + qs);
                    const js = await r.json();
                    const itens = Array.isArray(js) ? js : (js.items || []);
                    renderBanco(itens);
                  }
          } catch (e) {
              console.error(e);
              elBankGrid.innerHTML = '<small>Falha ao carregar banco.</small>';
          }
        }

        function renderBanco(itens) {
                      if (!elBankGrid) return;
                      if (!itens?.length) {
                        elBankGrid.innerHTML = '';
                        elBankEmpty?.setAttribute('style','');
                        return;
                      }
                      elBankEmpty?.setAttribute('style','display:none');
                      elBankGrid.innerHTML = '';
                      itens.forEach(it => {
                        const img = document.createElement('img');
                        img.src   = it.url || it.imagemUrl || '';
                        img.alt   = it.nome || '';
                        img.className = 'mi-bank-thumb';
                        img.addEventListener('click', () => {
                          // se voc√™ tiver uma fun√ß√£o para selecionar imagem do banco para um slot:
                          if (typeof window.selecionarImagemDoBanco === 'function') {
                            window.selecionarImagemDoBanco(it, elSlots);
                          }
                        });
                        elBankGrid.appendChild(img);
                      });
        }

        // ===== eventos =====
        // Recarregar banco (sem filtro)
        btnReloadBank?.addEventListener('click', () => carregarBancoImagens());

        // Menu do banco (abrir/fechar)
        btnBankMenu?.addEventListener('click', () => {
          const pop = $('#miBankMenu');
          if (pop) pop.hidden = !pop.hidden;
        });

        // Buscar por descri√ß√£o
        btnBankByDesc?.addEventListener('click', async () => {
          const termo = prompt('Descri√ß√£o cont√©m:');
          if (termo !== null) await carregarBancoImagens({ q: termo });
        });

        // Buscar por fornecedor//
        btnBankByFor?.addEventListener('click', async () => {
                //   const forn = prompt('Fornecedor cont√©m:');
                //   if (forn !== null) await carregarBancoImagens({ fornecedor: forn });
        });

        
  
    // ‚¨áÔ∏è coleta direto do array de controle que voc√™ j√° preenche
    // BLOCO 4 ‚Äî Gravar imagens (usa suas fun√ß√µes existentes)
    btnGravar?.addEventListener('click', async ()=>{
            alert('ATEN√á√ÉO!')
            //console.log('80000') 

            console.log(' [ 1121 =>originalSlots ] ',originalSlots[0])
            console.log(' [ 1122 =>slots ]',slots[0]);

            console.log( 'cur.type', )
            const temAlgo = slots.some(Boolean);
            if (!temAlgo){ alert('Nenhuma imagem selecionada.'); return; }

            // --- diffs (igual ao que voc√™ j√° vinha usando) ---
            const sameRef = (a,b)=> !!(a&&b) && (
                (a.key && b.key && a.key===b.key) ||
                (!a.key && !b.key && a.url && b.url && a.url===b.url)
            );

            const removed=[], refsAdd=[], uploads=[];
            for (let i=0;i<MAX_SLOTS;i++){
                const orig = originalSlots[i];
                const cur  = slots[i];
                if (!orig && !cur) continue;
                if (!orig && cur){ (cur.type==='local' || 'file' ?  uploads : refsAdd).push({idx:i, ...cur}); continue; }
                if (orig && !cur){ removed.push({idx:i, ...orig}); continue; }
                if (cur.type==='file' ||'local'){ removed.push({idx:i, ...orig}); uploads.push({idx:i, ...cur}); }
                else if (cur.type==='bank'){ sameRef(orig,cur) ? 0 : (removed.push({idx:i, ...orig}), refsAdd.push({idx:i, ...cur})); }
            }

            try{
                // aqui voc√™ chama suas fun√ß√µes j√° existentes:
                console.log(' vamos para salvarImagens_Compat');
                //{{!-- AQUI VAMOS GRAVAR A IMAGEM NO SPACE --}}
                await salvarImagensCompat({
                  produtoId:    $miProdId.value,
                  descricao:    $miDescricao.value,
                  fornecedor:   $miFornecedor.value,
                  departamento: $miDepartamento.value,
                  refsAdd, uploads, removed,
                  order: slots.map((s,i)=> s ? (s.type==='bank'?{type:'bank',idx:i,key:s.key}:{type:'file' || 'local',idx:i,filename:s.file?.name||null}) : null)
                }, slots);

                alert('Imagens gravadas com sucesso.');
                //$backdrop.classList.remove('show');
                //$backdrop.setAttribute('aria-hidden','true');
                window.__fecharModal();
            }catch(e){
                console.error(e); alert('[ 1128 ] Erro ao gravar imagens. Veja o console.');
            }
    });
  

  
  

    // meta (se voc√™ j√° usa)
  
  //  fd.append('lojistaId', urlParams.get('lojista') || '');
  //  fd.append('produtoId', document.getElementById('miProdId')?.value || '');
  //  fd.append('fornecedorId', document.getElementById('fornecedorSelect')?.value || '');
  //  console.log('');
  //  console.log('FD => ',fd);
  //  console.log('');

  //  const resp = await fetch('/empresa/produtos/imagens/upload', { method: 'POST', body: fd });
  //  if (!resp.ok) throw new Error(await resp.text());

  //  alert('Imagens gravadas com sucesso!');
    // opcional: recarregar banco/limpar sele√ß√£o
  //} catch (err) {
  //  console.error(err);
  //  alert('Erro ao gravar imagens: ' + err.message);
  //}
//});

  

  // opcional: carregue o banco ao abrir a p√°gina/modal
  //document.addEventListener('DOMContentLoaded', () => carregarBancoImagens());
})();
</script>
<input id="miHiddenFile" type="file" accept="image/*" style="display:none" class="slot-input" />

<input id="fileInput1" class="slot-input" type="file" accept="image/*" hidden>
<input id="fileInput2" class="slot-input" type="file" accept="image/*" hidden>
<input id="fileInput3" class="slot-input" type="file" accept="image/*" hidden>
<input id="fileInput4" class="slot-input" type="file" accept="image/*" hidden>
<input id="fileInput5" class="slot-input" type="file" accept="image/*" hidden>
<input id="fileInput6" class="slot-input" type="file" accept="image/*" hidden>
<input id="fileInput7" class="slot-input" type="file" accept="image/*" hidden>

<script>
/* util: normaliza texto */
function norm(s=''){
  return s.toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/[^a-z0-9\s]/g,' ')
    .replace(/\s+/g,' ')
    .trim();
}

/* util: tokens ‚â• 3 letras (para o texto do produto) */
function tokens(s=''){ return norm(s).split(' ').filter(w => w.length >= 3); }

/* valida: pelo menos UMA palavra do produto aparece como substring no nome do arquivo */
function temPalavraIgual(nomeArquivo, textoProduto){
  const nome = norm(nomeArquivo).replace(/\.[^.]+$/, ''); // tira extens√£o
  return tokens(textoProduto).some(t => nome.includes(t));
}

/* apenas para exibir no alerta (sem ‚Äúde/da/do/das/dos‚Äù, sem extens√£o, etc.) */
function pretty(s=''){
  const base = s.replace(/\.[^.]+$/,'').replace(/[_-]+/g,' ').replace(/\s+/g,' ').trim();
  const stop = new Set(['de','da','do','das','dos']);
  return base.split(' ').filter(w => !stop.has(w.toLowerCase())).join(' ');
}

const produtoTexto = document.getElementById('miDescricao')?.value || '';

function onFileChange(e){
  if (e.target.type !== 'file') return;
  const files = e.target.files;
  if (!files || files.length === 0) return;   // cancelou

  const f = files[0];
  if (!temPalavraIgual(f.name, produtoTexto)){
    const nomeArquivo = pretty(f.name);
    const nomeProduto = pretty(produtoTexto);
    alert(
      'O nome do arquivo precisa ter pelo menos UMA palavra igual √† descri√ß√£o do produto.\n\n' +
      `Arquivo: ${nomeArquivo}\n` +
      `Produto: ${nomeProduto}`
    );
    e.target.value = '';
    e.target.blur();
  }
}

/* liga em TODOS os inputs type="file" desta p√°gina */
document.querySelectorAll('input[type="file"]').forEach(inp=>{
  inp.removeEventListener('change', onFileChange); // evita bind duplicado
  inp.addEventListener('change', onFileChange);
});

/* opcional: log ao abrir seletor (ajuda debug) */
document.querySelectorAll('input[type="file"]').forEach(inp=>{
  inp.addEventListener('click', ()=>console.log('abrindo seletor de', inp.id));
});
</script>


<script>
  window.$hiddenFile = document.getElementById('miHiddenFile');
</script>
<script>
  
// === CORE DOS SLOTS (precisa existir ANTES de usar resetSlots) ===
const MAX_SLOTS = 7;
//const slots         = Array(MAX_SLOTS).fill(null);
const originalSlots = Array(MAX_SLOTS).fill(null);
const slots=window.slots || (window.slots=[]);
let nextIdx = 0;

function firstEmpty(){ for (let i=0;i<MAX_SLOTS;i++) if (!slots[i]) return i; return -1; }
function recompute(){ nextIdx = firstEmpty(); }

function addEmptySlot(i){
  const slot = document.createElement('div');
  slot.className = 'mi-slot empty';
  slot.dataset.idx = i;
  slot.dataset.num = i + 1;
  slot.addEventListener('click', () => {
  const hf = window.$hiddenFile || document.getElementById('miHiddenFile');
  if (!hf) return;                 // se ainda n√£o existir, n√£o faz nada
  hf.dataset.targetIdx = String(i);
  hf.value = '';
  hf.click();                      // abre o seletor de arquivos
});

  const btn = document.createElement('button');
  btn.className = 'mi-remove'; btn.title = 'Remover'; btn.textContent = '√ó';
  btn.addEventListener('click', ev => { ev.stopPropagation(); clearSlot(i); });
  slot.appendChild(btn);
  if (window.$miSlotGrid) $miSlotGrid.appendChild(slot);
  slots[i] = null;
}

function resetSlots(){
  if (!window.$miSlotGrid) return;
  $miSlotGrid.innerHTML = '';
  for (let i = 0; i < MAX_SLOTS; i++) addEmptySlot(i);
  recompute();
}

function fillSlot(i, src){
  const slot = $miSlotGrid?.children?.[i];
  if (!slot) return;
  slot.className = 'mi-slot filled';
  slot.innerHTML = '';
  const img = document.createElement('img'); img.src = src; slot.appendChild(img);
  const btn = document.createElement('button');
  btn.className = 'mi-remove'; btn.title = 'Remover'; btn.textContent = '√ó';
  btn.addEventListener('click', ev => { ev.stopPropagation(); clearSlot(i); });
  slot.appendChild(btn);
  recompute();
}

function clearSlot(i){
  const slot = $miSlotGrid?.children?.[i];
  if (!slot) return;
  slot.className = 'mi-slot empty';
  slot.innerHTML = '';
  const btn = document.createElement('button');
  btn.className = 'mi-remove'; btn.title = 'Remover'; btn.textContent = '√ó';
  btn.addEventListener('click', ev => { ev.stopPropagation(); clearSlot(i); });
  slot.appendChild(btn);
  slots[i] = null;
  recompute();
}
</script>

{{!-- //////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////// --}}
<script>
    // BLOCO 2 ‚Äî Carregar vinculadas e abrir
    async function carregarImagensDoProduto(produtoId, pageurls = []){
          console.log('carregarImagensDoProduto')
          originalSlots.fill(null);

          if (!produtoId) return;

          let lista = [];
          try {
              // ajuste a rota se a sua for diferente
              const r = await fetch(`/gravafoto/produtoImagem/buscar/${encodeURIComponent(produtoId)}`, { cache: 'no-store' });
              if (r.ok) lista = await r.json();
              console.log('===================================');
              console.log(lista);
              console.log('===================================');
          } catch (e) {
            console.warn('[carregarImagensDoProduto] falhou ao buscar por ID:', e);
            return;
          }

          console.log(lista)

          // 1) A API pode devolver o PRODUTO com 'pageurls' OU uma lista de imagens.
          //    Detecta e normaliza para [{url, key}].
          let docs = [];

          // caso 1: veio um produto com pageurls
          if (Array.isArray(lista) && lista.length && Array.isArray(lista[0].pageurls)) {
            docs = lista[0].pageurls
              .map(u => ({ url: String(u || '').trim(), key: null }))
              .filter(d => !!d.url);

          // caso 2: veio uma lista de registros de imagem
          } else {
            docs = (Array.isArray(lista) ? lista : [])
              .map(x => ({
                url: x.imagemUrl || x.url || '',
                key: x.shortkey || x.key || x._id || ''
              }))
              .filter(x => !!x.url);
          }

          console.log('');
          console.log('=> ',docs);
          console.log('');
          // 2) mescla 'pageurls' recebidos por par√¢metro (se voc√™ passar da tela)
          if (Array.isArray(pageurls)) {
            pageurls.forEach(u => {
              const s = String(u || '').trim();   // <‚Äî aqui √© String, n√£o string
              if (!s) return;
              if (!docs.some(d => d.url === s)) docs.push({ url: s, key: null });
                          });
          }


          if (!$miSlotGrid || !$miSlotGrid.children.length) resetSlots();
 
            for (const it of docs.slice(0, MAX_SLOTS)) {
                  const i = firstEmpty();
                  if (i === -1) break;

                  console.log('it.url =>', it.url);

                  slots[i]         = { type:'bank', url: it.url, key: it.key, origin:'existing' };
                  originalSlots[i] = { url: it.url, key: it.key };
                  fillSlot(i, it.url);   // usa sua fun√ß√£o j√° existente
            }
             

    }


    async function _abrirModalImagemImpl({ produtoId='', descricao='', fornecedor='', departamento='', pagerUrls=[] } = {}){
                console.log('[IMG] abrirModalImagemImpl()', { produtoId, descricao, fornecedor, departamento });
                if (window.acoCloseMenus) window.acoCloseMenus();

  // (se quiser) garante que nenhum select fique ‚Äúpreso‚Äù
  // __resetSelectIfNeeded?.();

  $miProdId.value       = String(produtoId||'');
  $miDescricao.value    = String(descricao||'');
  $miFornecedor.value   = String(fornecedor||'');
  $miDepartamento.value = String(departamento||'');

  clearBankUI(true);

  if (typeof resetSlots === 'function') resetSlots();
  else if (window.$miSlotGrid) $miSlotGrid.innerHTML = '';

  originalSlots.fill(null);

  try {
    await carregarImagensDoProduto(produtoId);
    console.log('[IMG] imagens vinculadas carregadas');
  } catch (e) {
    console.error('[IMG] erro carregarImagensDoProduto', e);
  }

  $backdrop.classList.add('show');
  $backdrop.setAttribute('aria-hidden','false');
}
    window.abrirModalImagem = _abrirModalImagemImpl; // mant√©m global
</script>
<script>
    // garante refer√™ncias j√° criadas ($backdrop, resetSlots, etc.)
    function __limparEstadoDoModal(){
      try { if (typeof resetSlots === 'function') resetSlots(); } catch(e){}
      try { originalSlots.fill(null); } catch(e){}
      try { if ($miBankGrid) $miBankGrid.innerHTML = ''; } catch(e){}
      try { if (typeof setBankEmptyState === 'function') setBankEmptyState(true); } catch(e){}
      try { __lastBankCriteria = { descricao:'', fornecedor:'' }; } catch(e){}
      try { if ($miBankMenu){ $miBankMenu.classList.remove('show'); $miBankMenu.setAttribute('hidden',''); } } catch(e){}
      try { if ($hiddenFile){ $hiddenFile.value=''; if ($hiddenFile.dataset) delete $hiddenFile.dataset.targetIdx; } } catch(e){}
    }

    function __fecharModal(){
      if (!$backdrop) return;
      $backdrop.classList.remove('show');
      $backdrop.setAttribute('aria-hidden','true');
      __limparEstadoDoModal();

      window.limparMenuAcoes?.();
    }

    // deixa dispon√≠vel mesmo se os listeners forem definidos antes
    window.__fecharModal = __fecharModal;
</script>
<script>
    // BLOCO 3 ‚Äî Banco de imagens (filtro leve por descri√ß√£o)
    async function carregarBcoImagens({descricao, fornecedor, departamento}){
        __lastBankCriteria = { descricao: descricao || '', fornecedor: fornecedor || '' };

        $miBankGrid.innerHTML = '';
        setBankEmptyState(false);

        try{
          const q = new URLSearchParams({
            descricao: descricao || '',
           // fornecedor: fornecedor || '',
           // departamento: departamento || ''
          }).toString();

          console.log('');
          console.log(' [1484] valor de q',q)
          console.log('');
          console.log('',descricao)
          const r = await fetch(`/gravafoto/buscarBcoImg?${q}`, { cache: 'no-store' });
          if (!r.ok) throw new Error('Falha ao buscar banco de imagens');
          //console.log(' Retorno da consulta / Gravafoto/buscarBcoImg?',r.json())
          let lista = await r.json();
          if (!Array.isArray(lista)) lista = [];
          console.log( 'LISTA => ',lista) 
          // filtro leve por descri√ß√£o do produto
          if (descricao) lista = lista.filter(it => 
                  matchDescricaoTexto(
                    it?.produtoNome||it?.url||'', descricao
                  )
            );

          if (!lista.length){ setBankEmptyState(true); return; }

          $miBankGrid.innerHTML = '';              // garante limpar antes
          setBankEmptyState(false); 

          console.log('lista ',lista.length)

          for (const it of lista){
            const card = document.createElement('div'); 
            card.className='mi-thumb';
            const img  = document.createElement('img'); 
            img.loading='lazy';
            img.src = it.url || it.imagemUrl; 
            card.appendChild(img);

            card.addEventListener('click', ()=>{
              const i = firstEmpty(); 
              if (i===-1){ alert('Limite de 7 imagens.'); return; }

              slots[i] = { type:'bank', url: it.url, key: it.key||null, origin:'bank' };
              fillSlot(i, it.url);
            });
            console.log('');

            console.log('')
           // console.log('',card);
            console.log(firstEmpty());
            console.log('')
            $miBankGrid.appendChild(card);
          }
        }catch(e){
          console.error(e);
          setBankEmptyState(true);
        }
    }

    // Recarregar usa o √∫ltimo crit√©rio (se existir), sen√£o pega os inputs
    $miReloadBank?.addEventListener('click', ()=>{
      const hasLast = (__lastBankCriteria.descricao || __lastBankCriteria.fornecedor);
      const crit = hasLast
        ? { ...__lastBankCriteria, departamento: '' }
        : { descricao: $miDescricao.value || '', fornecedor: $miFornecedor.value || '', departamento: $miDepartamento.value || '' };
      carregarBcoImagens(crit);
    });

    function openBankMenu(){
      if(!$miBankMenu || !$miBankMenuBtn) return;

      // garante que o menu √© filho do bloco da esquerda do rodap√©
      const anchorWrap = $miBankMenuBtn.closest('.mi-footer-left');
      if (anchorWrap && $miBankMenu.parentElement !== anchorWrap) {
        anchorWrap.appendChild($miBankMenu);
      }

      // for√ßa posi√ß√£o fixa no lado esquerdo
      $miBankMenu.style.left   = '0';
      $miBankMenu.style.right  = 'auto';
      $miBankMenu.style.bottom = '56px';

      $miBankMenu.classList.add('show');
      $miBankMenu.removeAttribute('hidden');
    }

    function closeBankMenu(){
      if(!$miBankMenu) return;
      $miBankMenu.classList.remove('show');
      $miBankMenu.setAttribute('hidden','');
    }

    $miBankMenuBtn?.addEventListener('click', (e)=>{
      e.stopPropagation();
      if ($miBankMenu.classList.contains('show')) closeBankMenu();
      else openBankMenu();
    });

    // fecha menu ao clicar fora
    document.addEventListener('click', (e)=>{
      if (!$miBankMenu?.classList.contains('show')) return;
      const t = e.target;
      if (!$miBankMenu.contains(t) && !$miBankMenuBtn.contains(t)) closeBankMenu();
    });

    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeBankMenu(); });

    // a√ß√µes do menu
    $miBankMenuDesc?.addEventListener('click', ()=>{
      closeBankMenu();
      __lastBankCriteria = { descricao: $miDescricao.value || '', fornecedor: '' };
      carregarBcoImagens({ ...__lastBankCriteria, departamento: '' });
    });
    $miBankMenuFor?.addEventListener('click', ()=>{
      closeBankMenu();
      __lastBankCriteria = { descricao: '', fornecedor: $miFornecedor.value || '' };
      carregarBcoImagens({ ...__lastBankCriteria, departamento: '' });
    });


    // atalhos existentes (mant√©m)
    $miClearAll?.addEventListener('click', resetSlots);

    // bot√£o X (fechar)
    $miClose?.addEventListener('click', ()=>window.__fecharModal?.());
    

    // clique no fundo do backdrop
    $backdrop?.addEventListener('click', (ev)=>{ if (ev.target === $backdrop) window.__fecharModal?.(); });

    // ESC
   window.addEventListener('keydown', (ev)=>{ if (ev.key === 'Escape' && $backdrop.classList.contains('show')) window.__fecharModal?.(); });
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  // garante que o grid exista
  if (typeof resetSlots === 'function') resetSlots();

  // quando o usu√°rio escolhe arquivos, preenche os slots
  if (window.$hiddenFile) {
    $hiddenFile.addEventListener('change', (ev) => {
      const files = Array.from(ev.target.files || []);
      // slot alvo: o que foi clicado, sen√£o o pr√≥ximo vazio
      let idx = Number($hiddenFile.dataset.targetIdx ?? nextIdx);
      if (Number.isNaN(idx) || idx < 0 || idx >= MAX_SLOTS) idx = firstEmpty();

      files.forEach((f) => {
        if (!f || !/^image\//.test(f.type)) return;
        const url = URL.createObjectURL(f);

        // registra no array de controle
        slots[idx] = { type: 'local', file: f, url };
        // atualiza UI
        fillSlot(idx, url);

        // pr√≥ximo slot vazio
        idx = firstEmpty();
      });

      // limpa sele√ß√£o para permitir re-escolher o mesmo arquivo depois
      ev.target.value = '';
      delete $hiddenFile.dataset.targetIdx;
    });
  }
});
</script>
<script>
 //* 0) uploads (presigned + PUT + salvar)
 //* 1) Para cada upload: pega presigned, faz PUT e depois salva JSON
 //* 2) Para cada ref nova: salva JSON direto
 //* (Removed: deixamos logado por enquanto; plugamos quando houver rota)
 //*/
 function pad2(n){ return String(n+1).padStart(2,'0'); }
async function salvarImagensCompat({ produtoId, descricao, fornecedor, departamento, refsAdd, uploads, removed, order },slotsRef){
        // 1) uploads (presigned + PUT + salvar)
        console.log(' estamos dentro de salvarImagensCompat');
        console.log( 'uploads',uploads);
        console.log('');
        for (const u of uploads){
                const idx  = u.idx;
                const s    = slotsRef[idx];
                const file = s?.file;
                if (!file) continue;

                // 1.1 pega presigned
                const qs = new URLSearchParams({
                  filename: file.name,
                  filetype: file.type || 'image/png',
                  ordem: pad2(idx)
                });
                console.log(' [ 1596 ]')
                console.log(' qs=>>',qs)
                console.log('');
              //  return
                const r = await fetch(`/gravafoto/getpresignedurl?${qs.toString()}`, { cache: 'no-store' });
                console.log('R =====',r)
                if (!r.ok) throw new Error('Falha ao obter URL de upload');
                const { uploadUrl, key } = await r.json();

                console.log(' 1536 ',uploadUrl)
                // 1.2 envia para o Space
                const up = await fetch(uploadUrl, {
                      method: 'PUT',
                      body: file,
                      headers: {
                        'Content-Type': file.type,   // deve bater com filetype usado na assinatura
                        'x-amz-acl': 'public-read'   // mant√©m p√∫blico ao salvar
                  }
                });                

                if (!up.ok) throw new Error('Falha ao enviar arquivo para o Space');

                const publicUrl = uploadUrl.split('?')[0];

                // 1.3 grava registro no seu banco
                console.log(' [ 1418 ]',publicUrl)
                await postSalvarImagem({
                  produtoId, descricao, fornecedor, departamento,
                  imagemUrl: publicUrl,
                  shortkey:  key,
                  mimeType:  file.type || 'image/png',
                  size:      file.size,
                  ordem:     pad2(idx)
                });
        }

        // 2) refs novas (n√£o precisam de upload)
        for (const r of refsAdd){
          await postSalvarImagem({
            produtoId, descricao, fornecedor, departamento,
            imagemUrl: r.url,
            shortkey:  r.key,
            mimeType:  'image/*',
            size:      0,
            ordem:     pad2(r.idx)
          });
        }

        // 3) removidos (se tiver rota depois plugamos aqui)
        if (removed.length){
          console.warn('[remove] pendente de integrar no servidor:', removed);
        }

        // 4) ordem final (se voc√™ quiser aplicar do lado do servidor)
        console.info('[order] estado final pedido:', order);
}


/** POST JSON no endpoint que voc√™ j√° usa */
async function postSalvarImagem({
        produtoId, descricao, fornecedor, departamento,
        imagemUrl, shortkey, mimeType, size, ordem
      }){
        const body = {
          codigoId:     produtoId,
          produtoNome:  descricao,
          fornecedor:   fornecedor,
          departamento: departamento,
          imagemUrl,
          shortkey,
          mimeType,
          size,
          ordem
  };

  console.log('[ 1604 ] POSTSALVARIMAGEM',body)
  const res = await fetch('/gravafoto/imagem/salvar', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });
  if (!res.ok) {
    const t = await res.text().catch(()=> '');
    throw new Error(`Falha ao gravar imagens: ${res.status} ${t}`);
  }
  return res.json().catch(()=> ({}));
}


</script>
<script>
(function(){
  const bar   = document.getElementById('filtrosProdutos');
  const pager = document.querySelector('.pager-inline');

  function setHeights(){
    const bh = bar   ? Math.round(bar.getBoundingClientRect().height)   : 48;
    const ph = pager ? Math.round(pager.getBoundingClientRect().height) : 34;
    document.documentElement.style.setProperty('--bar-h',   bh + 'px');
    document.documentElement.style.setProperty('--pager-h', ph + 'px');
  }

  window.addEventListener('load', setHeights);
  window.addEventListener('resize', setHeights);
  // se os selects mudarem de tamanho, recalcula
  document.getElementById('filtroStatus')?.addEventListener('change', setHeights);
  document.getElementById('filtroFornecedor')?.addEventListener('change', setHeights);
  document.getElementById('filtroModo')?.addEventListener('change', setHeights);
})();
</script>
<script>
// === helpers globais (uma vez s√≥) ===

  (function(){
  if (!window.__norm) {
    window.__norm = function(s){
      return String(s || '')
        .normalize('NFD')
        .replace(/\p{Diacritic}/gu, '')
        .toLowerCase()
        .trim();
    };
  }

 if (!window.__STOP) {
    window.__STOP = new Set(['de','da','do','das','dos','mm','cm','m','x','para','e']);
  }

  if (!window.matchDescricaoTexto) {
    window.matchDescricaoTexto = function(texto, consulta){
      const A = __norm(texto).split(/[^a-z0-9]+/g).filter(t => t && !__STOP.has(t) && !/^\d+$/.test(t));
      const B = __norm(consulta).split(/[^a-z0-9]+/g).filter(t => t && !__STOP.has(t) && !/^\d+$/.test(t));
      if (!B.length) return true;

      let hits = 0;
      for (const t of B){
        if (A.some(a => a.includes(t) || t.includes(a))) hits++;
      }
      const need = Math.min(2, Math.ceil(B.length / 2));
      return hits >= need;
    };
  }
})();
</script>
{{!-- conserva as √∫ltimas palavras digitadas no input --}}
{{!-- <script>
const KEY = 'hist_codigo';

function carregarXHist() {
  const arr = JSON.parse(localStorage.getItem(KEY) || '[]');
  document.getElementById('hist-codigo').innerHTML =
    arr.map(v => `<option value="${v}">`).join('');
}

function salvarNoHist(valor) {
  const v = (valor || '').trim();
  if (!v) return;
  const arr = JSON.parse(localStorage.getItem(KEY) || '[]');
  const i = arr.indexOf(v);
  if (i > -1) arr.splice(i, 1);   // remove duplicado
  arr.unshift(v);                  // coloca no topo
  localStorage.setItem(KEY, JSON.stringify(arr.slice(0, 5))); // s√≥ 5
  carregarXHist();
}

document.addEventListener('DOMContentLoaded', carregarXHist);
document.getElementById('codigo').addEventListener('change', e => salvarNoHist(e.target.value));
</script> --}}

{{!-- <script>
  document.querySelectorAll('.slot-input').forEach(input => {
  input.addEventListener('change', e => {
    const file = e.target.files[0];
    const slotIndex = e.target.id.replace('fileInput', '');
    const preview = document.getElementById('preview' + slotIndex);
    const label = e.target.previousElementSibling;

    if (file) {
      const reader = new FileReader();
      reader.onload = ev => {
        preview.src = ev.target.result;
        preview.hidden = false;
        label.hidden = true;
      };
      reader.readAsDataURL(file);
    }
  });
});

</script> --}}
