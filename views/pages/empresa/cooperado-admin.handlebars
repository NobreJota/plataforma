<!DOCTYPE html>
<html lang="pt-br">
{{!-- <head> --}}
    <meta http-equiv="Cache-Control" content="no-store" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
     <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">       

    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css"> 
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    {{!-- <link rel="stylesheet" href="httpsX://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"> --}}
    {{!-- <link rel="stylesheet" href="httpsX://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"> --}}

    {{!-- <link rel="stylesheet" href="/css/fontawesome.min.css"> --}}
    <link rel="stylesheet" href="/css/dashboard.css">
    <link rel="stylesheet" href="/js/empresa/cadastro.js">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" defer></script>
    {{!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script> --}}
    {{!-- <script src='https://kit.fontawesome.com/a076d05399.js' crossorigin='anonymous'></script> --}}
    {{!-- <script src=""></script> --}}
  <script defer>
      window.colacerto = function () { }
  </script>
    <title>Rotaes  : Admin : lojista</title>
    <style>
      html, body{
  height: 100%;
  overflow: hidden;           /* <- trava scroll da p√°gina */
  background: #111;           /* opcional: cor de fundo padr√£o */
}

  :root{
    /* ser√° atualizado via JS para bater com a altura real do header */
    --h-top: 56px;        /* altura do header fixo */
    --gap: 12px;          /* respiro entre faixas */
    --z-top: 1030;        /* acima do conte√∫do */
    --z-toolbar: 1020;    /* abaixo do header, acima do conte√∫do */
  }



  /* ===== Header fixo ===== */
  .topbar{
    position: fixed; inset: 0 0 auto 0;
    z-index: var(--z-top);
    background: #0b2a3f; color:#fff;
    box-shadow: 0 2px 10px rgba(0,0,0,.2);
  }
  .topbar .brand{ font-weight: 800; color:#fff; text-decoration:none; }
  .topbar .brand .accent{ color:#47d1ff; }

  /* empurra a p√°gina para baixo da barra fixa */
  body{ padding-top: var(--h-top); background:#111; }

  /* ===== Faixa de filtros (painelLista) ===== */
  .painel-lista{
    position: sticky; top: var(--h-top); z-index: var(--z-toolbar);
  }

  .painel-lista .container-fluid{ padding-left: 0; padding-right: 16px; }

  painel-lista .pager-inline{
  display:flex; justify-content:center; align-items:center;
  padding: 6px 0; margin: 0;
}


  .painel-lista .toolbar{
    display: grid; gap: 10px; align-items: center;
    grid-template-columns: 1fr 1fr;        /* mobile */
  }
  .label-pill{
    font-weight:700; color:#b70000; margin-right:6px;
  }
  .toolbar .form-select{ min-height: 36px; }

  /* ===== Conte√∫do ===== */
  .content-wrap{
    height: calc(100vh - var(--h-top));
    padding: 0;                 /* sem respiro que criava o ‚Äúv√£o‚Äù */
    background: transparent;    /* tira o fundo pink */
  }

  /* Cabe√ßalho da tabela grudado no topo do cont√™iner com scroll */
#divTable{ 
   position: relative;
  height: 100%;               /* ocupa toda a .content-wrap */
  width: 98%;
  margin: auto;
  overflow-y: scroll;         /* <- barra SEMPRE vis√≠vel */
  overflow-x: auto;           /* horizontal quando necess√°rio */
  scrollbar-gutter: stable both-edges;  /* evita ‚Äúpulo‚Äù de layout */
  background-color: #100e0e;  /* seu fundo */
  
  };  
#divTable table{ border-collapse: separate; } /* evita glitches no sticky */

#divTable thead thead{ 
  position: sticky;
  top: 0;
  z-index: 5;
}


#divTable thead th{
  position: sticky;     /* alguns navegadores exigem no th tamb√©m */
  top: 0;
  z-index: 6;
  background: #dfb706;  /* mesma cor do cabe√ßalho da sua tabela */
  /* opcional: separador visual quando rolar */
  box-shadow: 0 2px 0 rgba(0,0,0,.06);
}

/* opcional: uma ‚Äúsombrinha‚Äù para separar visualmente quando rolar */
#divTable thead {
  box-shadow: 0 2px 0 rgba(0,0,0,.06);
}

.content-wrap{ padding-top: 0; }

  /* ===== Responsivo ===== */
  @media (min-width: 992px){
   .painel-lista .toolbar{
    grid-template-columns: 280px 1fr 280px;  /* desktop: Ativos | Fornecedores | Imagens */
    gap: 16px;
  }
  }

  /* nova linha da pagina√ß√£o dentro da faixa */
.painel-lista .pager{
  padding-top: 6px; padding-bottom: 6px;
  display: flex; justify-content: center; align-items: center;
  background: transparent;    /* mant√©m amarelo da faixa */
}

/* elimina ‚Äúv√£o‚Äù entre faixa e tabela */
.content-wrap{ padding-top: 8px; }
.table-wrap{ margin-top: 0 !important;}           /* se voc√™ usa um wrap da tabela */
.table{ margin-top: 0; }    
</style>
{{!-- ///////////////////////////////////////////////////////////////////////////// --}}
<style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      position: relative;
    }
   
    .bck-flex{
      background-color:#ffffff;height: 100vh;
    }
  </style>
  <style>
    * {box-sizing: border-box;}

    body {
      margin: 0;
      font-family: Arial, Helvetica, sans-serif;
    }

    .fixed-top{
      background-color:#023c6c ;width: 100%;margin:auto;padding: 6px;height: 3vh;margin-top: .2vh;
    }

    /* ===== layout da faixa ===== */
    /*:root{
      --toolbar-pad-y: 2px;
      --toolbar-pad-x: 16px;
      --toolbar-gap:  8px;
    }*/

    /* colunas dos filtros (j√° t√≠nhamos left/center/right) */
    .fx-col{ display:flex; align-items:center; gap:10px; }
    .fx-left, .fx-right{ flex:0 0 280px; min-width:240px; }
    .fx-center{ flex:1 1 520px; min-width:380px; }

    /* ===== r√≥tulos coloridos (na lateral de cada divis√£o) ===== */
    .label-pill{
      display:inline-block; font-weight:600; font-size:.95rem;
      padding:2px 8px; border-radius:4px;
      line-height:1.2; white-space:nowrap;
    }

    .lbl-ativos{ background:#ffdddd; color:#a30000; border:1px solid #ff6b6b; } /* vermelho claro */
    .lbl-forn  { background:#dfe9ff; color:#0833a2; border:1px solid #4d74ff; } /* azul */
    .lbl-img   { background:#fff1b3; color:#8a5a00; border:1px solid #ffd24d; } /* amarelo */

    /*position: sticky;*/
    .toolbar-sticky{
      
      top: 3.5vh;                          /* gruda no topo */
      z-index: 1020;                   /* acima do cabe√ßalho da tabela */
      background: #b05404e6;             /* sua cor de fundo atual */
      padding: var(--toolbar-pad-y) var(--toolbar-pad-x);
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: var(--toolbar-gap);
      border-bottom: 1px solid rgba(0,0,0,.08);
    }

    .toolbar-sticky .form-select.form-select-sm{ height: calc(2rem + 2px); }

    /* position: sticky;*/
    #filtrosProdutos{
    
      left:0
      top: 0;
      z-index: 900;
    }*/

    .pager-inline{
      flex: 1 1 100%;
      display:flex;
      justify-content:center;          /* centraliza */
      align-items:center;
      gap: 8px;
    }

    .faixa-topo {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        background-color: #fff;
        width: 80%;
        margin: auto;
      }

      /* ===== opcional: borda laranja da √°rea abaixo ===== */
    .faixa-topo + .faixa-borda {
      border:6px solid #ff8a00; border-top-left-radius:8px; border-top-right-radius:8px;
      border-bottom:none; height:14px; margin:6px 0 12px;
    }

    .faixa-topo .form-select.form-select-sm{
      height: calc(2rem + 2px);
      padding: .25rem .5rem;
    }

    .faixa-topo{ 
      padding: 2px 34px;                    /* mais espa√ßo left/right dentro da faixa */
      gap: 38px;                             /* espa√ßo entre colunas um pouco menor */
    }

    #menuLateral {
          width: auto;
          height: 94vh;
          position: absolute;
          top: 3.8vh;
          left: 0;
          display: flex;
          flex-direction: row;
          z-index: 1000;
          background-color: #fff;
        }

        #H2menuLateral {
          writing-mode: vertical-rl; /* vertical (de baixo para cima) */
          transform: rotate(180deg); /* inverte para cima para baixo */
          font-size: 1vw;
          color: #13e236;
          margin: 0;
          text-align: center;
          font-weight: 100;
          margin-left: .4vw;
        }

        #faixaVertical {
          width: 2vw;
          height: 96vh;
          background-color: #295ee4;
          z-index: 800;
          display: flex;
          flex-direction: column;
          justify-content: space-around;
        }

    #menulista {
          width: 13vw;
          height: 96vh;
          background-color:transparent;
          margin-top: 2px;
          transition: margin-left 0.4s ease;
          margin-left: -10vw; /* Escondido inicialmente */
        }
    
        @media screen and (max-width: 600px) {
          .topnav .search-container {
            float: none;
          }
          .topnav a, .topnav input[type=text], .topnav .search-container button {
            float: none;
            display: block;
            text-align: left;
            width: 100%;
            margin: 0;
            padding: 14px;
          }
          .topnav input[type=text] {
            border: 1px solid #ccc;  
          }
        }
</style>
  <style>
* {box-sizing: border-box;}

body {
  margin: 0;
  font-family: Arial, Helvetica, sans-serif;
}

.fixed-top{
   background-color:#023c6c ;width: 100%;margin:auto;padding: 6px;height: 3vh;margin-top: .2vh;
}

/* ===== layout da faixa ===== */
:root{
  --toolbar-pad-y: 2px;
  --toolbar-pad-x: 16px;
  --toolbar-gap:  8px;
}
/* colunas dos filtros (j√° t√≠nhamos left/center/right) */
.fx-col{ display:flex; align-items:center; gap:10px; }
.fx-left, .fx-right{ flex:0 0 280px; min-width:240px; }
.fx-center{ flex:1 1 520px; min-width:380px; }

/* ===== r√≥tulos coloridos (na lateral de cada divis√£o) ===== */
.label-pill{
  display:inline-block; font-weight:600; font-size:.95rem;
  padding:2px 8px; border-radius:4px;
  line-height:1.2; white-space:nowrap;
}

.lbl-ativos{ background:#ffdddd; color:#a30000; border:1px solid #ff6b6b; } /* vermelho claro */
.lbl-forn  { background:#dfe9ff; color:#0833a2; border:1px solid #4d74ff; } /* azul */
.lbl-img   { background:#fff1b3; color:#8a5a00; border:1px solid #ffd24d; } /* amarelo */

/*position: sticky;*/
.toolXbar-sticky{
  top: 3.5vh;                          /* gruda no topo */
  z-index: 1020;                   /* acima do cabe√ßalho da tabela */
  background: #fff0e3e6;             /* sua cor de fundo atual */
  padding: var(--toolbar-pad-y) var(--toolbar-pad-x);
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: var(--toolbar-gap);
  border-bottom: 1px solid rgba(0,0,0,.08);
}

.toolXbar-sticky .form-select.form-select-sm{ height: calc(2rem + 2px); }

 /* position: sticky;*/
#filtrosXProdutos{

  left:0
  top: 0;
  z-index: 900;
}

.pager-inline{
  flex: 1 1 100%;
  display:flex;
  justify-content:center;          /* centraliza */
  align-items:center;
  gap: 8px;
}

.faixa-topo {
    display: flex;
    flex-direction: row;
    justify-content: space-between;
    background-color: #fff;
    width: 80%;
    margin: auto;
   }

   /* ===== opcional: borda laranja da √°rea abaixo ===== */
.faixa-topo + .faixa-borda {
  border:6px solid #ff8a00; border-top-left-radius:8px; border-top-right-radius:8px;
  border-bottom:none; height:14px; margin:6px 0 12px;
}

.faixa-topo .form-select.form-select-sm{
  height: calc(2rem + 2px);
  padding: .25rem .5rem;
}

.faixa-topo{ 
  padding: 2px 34px;                    /* mais espa√ßo left/right dentro da faixa */
  gap: 38px;                             /* espa√ßo entre colunas um pouco menor */
}

#menuLateral {
      width: auto;
      height: 94vh;
      position: absolute;
      top: 3.8vh;
      left: 0;
      display: flex;
      flex-direction: row;
      z-index: 1000;
      background-color: #fff;
    }

    #H2menuLateral {
      writing-mode: vertical-rl; /* vertical (de baixo para cima) */
      transform: rotate(180deg); /* inverte para cima para baixo */
      font-size: 1vw;
      color: #13e236;
      margin: 0;
      text-align: center;
      font-weight: 100;
      margin-left: .4vw;
    }

    #faixaVertical {
      width: 2vw;
      height: 96vh;
      background-color: #295ee4;
      z-index: 800;
      display: flex;
      flex-direction: column;
      justify-content: space-around;
    }

#menulista {
       width: 13vw;
       height: 96vh;
       background-color:transparent;
       margin-top: 2px;
       transition: margin-left 0.4s ease;
       margin-left: -10vw; /* Escondido inicialmente */
    }
    
@media screen and (max-width: 600px) {
  .topnav .search-container {
    float: none;
  }
  .topnav a, .topnav input[type=text], .topnav .search-container button {
    float: none;
    display: block;
    text-align: left;
    width: 100%;
    margin: 0;
    padding: 14px;
  }
  .topnav input[type=text] {
    border: 1px solid #ccc;  
  }
}
</style>
<style>
 #main {
      width: 100vw;
      height: 100vh; /* altura para visualiza√ß√£o completa */
      background-color: #5e5c5c; /* apenas para visualiza√ß√£o */
      position: relative; /* necess√°rio para iniciar o contexto de empilhamento */
      z-index: 1; /* camada inferior */
    }

    .grade{
      width:calc(100vw - 2.5vw);
      height: 100%;
      background-color: #ffffff;
      color:#295ee4;
      margin-top:0;
    }

    .edit-row {
      background-color: #f6990e; /* Amarelo claro */
    }

    .delete-row {
      background-color: #c40303; /* Vermelho claro */
    }

    .btn-warning{
       background-color: #b87004;
       color:#fff;
    }

    .btn-danger{
       background-color: #f90532;
       color:#fff;
    }

    .selected-row {
      background-color: unset;
    }
  </style>

{{!-- ///////////////////////////////////////////////////////////////////////////// --}}
<header class="topbar">
  <div class="container-fluid py-2">
    <div class="d-flex align-items-center justify-content-between">
      <a href="/" class="brand">
        Rota<span class="accent">es</span>
      </a>
    </div>
  </div>

<section class="painel-lista">
  <div class="container-fluid py-2">
    <div class="toolbar">
      <!-- Ativos -->
      <div class="d-flex align-items-center">
        <span class="label-pill">Ativos:</span>
        <select class="form-select form-select-sm">
          <option>Todos</option>
          <option>Somente ativos</option>
          <option>Inativos</option>
        </select>
      </div>

      <!-- Fornecedores -->
      <div class="d-flex align-items-center">
        <span class="label-pill">Fornecedores:</span>
        <select class="form-select form-select-sm">
          <option>Todos</option>
          {{!-- op√ß√µes reais aqui --}}
        </select>
      </div>

      <!-- Imagens -->
      <div class="d-flex align-items-center">
        <span class="label-pill">Imagens:</span>
        <select class="form-select form-select-sm">
          <option>Lista</option>
          <option>Grid</option>
          <option>Sem imagem</option>
        </select>
      </div>

          <!-- Pagina√ß√£o dentro da faixa amarela -->
    <nav class="pager-inline" aria-label="Pagina√ß√£o">
      <ul class="pagination pagination-sm mb-0">
        <li class="page-item {{#if (eq page 1)}}disabled{{/if}}">
          <a class="page-link" href="{{basePath}}?{{qsNoPage}}{{#if qsNoPage}}&{{/if}}page=1">¬´</a>
        </li>
        <li class="page-item {{#if (eq page 1)}}disabled{{/if}}">
          <a class="page-link" href="{{basePath}}?{{qsNoPage}}{{#if qsNoPage}}&{{/if}}page={{dec page}}">‚Äπ</a>
        </li>

        {{#each pageNumbers}}
          <li class="page-item {{#if (eq this ../page)}}active{{/if}}">
            <a class="page-link" href="{{../basePath}}?{{../qsNoPage}}{{#if ../qsNoPage}}&{{/if}}page={{this}}">{{this}}</a>
          </li>
        {{/each}}

        <li class="page-item {{#if (eq page pages)}}disabled{{/if}}"><a class="page-link" href="{{basePath}}?{{qsNoPage}}{{#if qsNoPage}}&{{/if}}page={{inc page}}">‚Ä∫</a></li>
        <li class="page-item {{#if (eq page pages)}}disabled{{/if}}"><a class="page-link" href="{{basePath}}?{{qsNoPage}}{{#if qsNoPage}}&{{/if}}page={{pages}}">¬ª</a></li>
      </ul>

      <a class="btn btn-outline-primary btn-sm ms-2"
         href="{{basePath}}?{{qsNoPage}}{{#if qsNoPage}}&{{/if}}page={{inc page}}">
        Pr√≥ximos 50 ¬ª
      </a>
    </nav>

    </div>
  </div>
</section>
{{!-- <div class="alert alert-light border">
      <nav class="pager-inline" aria-label="Pagina√ß√£o" style="background-color: #ffffff;">
              <ul class="pagination pagination-sm mb-0">
                <li class="page-item {{#if (eq page 1)}}disabled{{/if}}">
                  <a class="page-link" href="{{basePath}}?{{qsNoPage}}{{#if qsNoPage}}&{{/if}}page=1">¬´</a>
                </li>
                <li class="page-item {{#if (eq page 1)}}disabled{{/if}}">
                  <a class="page-link" href="{{basePath}}?{{qsNoPage}}{{#if qsNoPage}}&{{/if}}page={{dec page}}">‚Äπ</a>
                </li>

                {{#each pageNumbers}}
                  <li class="page-item {{#if (eq this ../page)}}active{{/if}}">
                    <a class="page-link" href="{{../basePath}}?{{../qsNoPage}}{{#if ../qsNoPage}}&{{/if}}page={{this}}">{{this}}</a>
                  </li>
                {{/each}}

                <li class="page-item {{#if (eq page pages)}}disabled{{/if}}">
                  <a class="page-link" href="{{basePath}}?{{qsNoPage}}{{#if qsNoPage}}&{{/if}}page={{inc page}}">‚Ä∫</a>
                </li>
                <li class="page-item {{#if (eq page pages)}}disabled{{/if}}">
                  <a class="page-link" href="{{basePath}}?{{qsNoPage}}{{#if qsNoPage}}&{{/if}}page={{pages}}">¬ª</a>
                </li>
              </ul>
              <a class="btn btn-outline-primary btn-sm ms-2"
                href="{{basePath}}?{{qsNoPage}}{{#if qsNoPage}}&{{/if}}page={{inc page}}">
                Pr√≥ximos 50 ¬ª
              </a>
      </nav>
</div> --}}
</header>
<body>
<main class="content-wrap">
  <div class="container-fluid">
    
    <div style="">
        <div id="painelLista" class="grade" style="display: block;background: #aea5ac;">
            <div id="divTable" style="overflow:auto;width:98%;height:90vh;margin:auto;background-color:#100e0e;">
                  <table id="tabelaProdutos" class="table  table-bordered" style="font-size: small;">
                    <thead class="fixar-apos-paginacao" style="color: #df061f;width: 100%;font-size:x-small ;font-weight: 400;" >
                    <tr style="background-color: #dfb706;">
                      <th style="width: 0.35vw;" onclick="ordenarTabela(0)" style="">Ord</th>
                      <th style="display: none;" >Id</th>
                      <th onclick="ordenarTabela(2)" style="width: 1vw;">C√≥digo</th>
                      <th onclick="ordenarTabela(3)" style="width: 13.4vw;">Descri√ß√£o</th>
                      <th onclick="ordenarTabela(4)" style="width: 13.8vw;">Complemento</th>
                      <th onclick="ordenarTabela(5)" style="width: 5.5vw;">Refer</th>
                      <th onclick="ordenarTabela(6)" style="width: 13vw;">Fornecedor</th>
                      <th onclick="ordenarTabela(7)">Segmento</th>
                      <th onclick="ordenarTabela(8)">Qte</th>
                      <th onclick="ordenarTabela(9)">Custo</th>
                      <th onclick="ordenarTabela(10)">Vista</th>
                      <th onclick="ordenarTabela(11)">Prazo</th>
                      <th >A√ß√µes</th>
                    </tr>
                </thead>
                    <tbody id="produtoTable">
                      {{#each produtos}}
                      <tr data-id="{{_id}}">
                        <td class="alinhar-center">{{inc @index}}</td>
                        <td style="display: none">{{_id}}</td>
                        <td>{{codigo}}</td>
                        <td>{{descricao}}</td>
                        <td>{{complete}}</td>
                        <td>{{referencia}}</td>
                        <td>{{fornecedor.marca}}</td>
                        <td>
                          {{#each localloja}}
                              {{#each departamento}}
                                <span class="departamento-click" data-index="{{@../index}}" style="font-weight: bold;color:red;">
                                  {{nomeDepartamento}}
                                </span>
                              {{/each}}
                            {{/each}}
                        </td>
                        <td class="alinhar-center">{{qte}}</td>
                        <td class="alinhar-direita">{{formatarDecimal precocusto}}</td>
                        <td class="alinhar-direita">{{formatarDecimal precovista}}</td>
                        <td class="alinhar-direita">{{formatarDecimal precoprazo}}</td>
                        <td>
                          <div style="display: flex;flex-direction: row;justify-content:space-around;gap: 4px; flex-wrap: wrap;background-color:transparent;">
                            <select 
                                    class="form-select form-select-sm" 
                                    onchange="executarAcaoComDataset(this)" 
                                    data-id="{{_id}}" 
                                    data-descricao="{{descricao}}" 
                                    data-fornecedor="{{fornecedor.razao}}"
                                    data-departamento ="{{localloja.[0].departamento.[0].nomeDepartamento}}">
                              <option value="" selected disabled>‚ãÆ</option>
                              {{!-- <option value="" selected hidden>‚ãÆ</option> --}}
                              <option value="vincular">üîó Vincular</option>
                              <option value="imagens">üñºÔ∏è Imagens</option>
                              <option  value="editar">‚úèÔ∏è Editar</option>
                              <option  value="deletar">üóëÔ∏è Deletar</option>
                            </select>
                            {{!-- // data-codigo="{{codigo}}"  --}}
                          </div>
                        </td>
                      </tr>
                      {{/each}}
                    </tbody>
                  </table>
            </div>
        </div>
    </div>
  </div>


</main>
<div id="menuLateral" class="" style="z-index: 1000;height: 100vh;background-color: #fff;margin-top:-0.6vh;">
        <div id="menulista" style="width: 10vw; height: 98vh;display: flex; flex-direction: column; justify-content: space-around; transition: margin-left 0.4s ease;">
          <!-- Conte√∫do do menu -->
          <div style="height: 15vh;background-color:#fff;"></div>
          <div style="display: flex; flex-direction: column; justify-content: space-between;background-color:#fff;text-align: left;margin: auto;height: 30vh;padding-top: 5vh;">
             <button style="border: block;background-color:#0833a2;color:#fff">
               <a id="passa-cadastrofornec" href="" style="text-decoration: none;color:#ffffff;">Cadastro fornecedor</a>
            </button>
            {{!-- <div style="height: 1vh;"></div> --}}
            {{!-- <div> --}}
              <button style="border: block;background-color:#0833a2;width: 100%;">
                {{!-- <h1 style="font-weight:200;color:#fff;font-size: small;"> --}}
                <a id="passa-listafornec" href="/fornec/listafornec/:{{this._id}}" style="text-decoration: none;color:#ffffff;">Lista fornecedor</a>
                {{!-- </h1> --}}
              </button>
            {{!-- </div> --}}
            
             <button class="btn btn-sm btn-primary"
                    type="button"
                    onclick="location.href='/cadproduto/cadastro?lojista={{lojista._id}}'">
              Cadastro de produtos
            </button>
            
          </div>
          <div style="height: 25vh;"></div>
        </div>
        <div id="faixaVertical" style="width: 2vw; height: 98vh; background-color:#0b56e1; display: flex; flex-direction: column; justify-content: space-around; z-index: 800;margin-top:-0.5vh;">
          <h2 id="H2menuLateral" style="font-size: 1vw; text-align: end; color: #fff;">Menu lateral</h2>
        </div>
</div>

<script>
  // mede a altura real do header e atualiza a vari√°vel CSS --h-top
  (function(){
    const root = document.documentElement;
    const header = document.querySelector('.topbar');
    function setHeaderHeight(){
      const h = header ? header.offsetHeight : 56;
      root.style.setProperty('--h-top', h + 'px');
    }
    window.addEventListener('load', setHeaderHeight, {once:true});
    window.addEventListener('resize', setHeaderHeight, {passive:true});
    // se tiver fontes web que alteram a altura mais tarde:
    document.fonts && document.fonts.addEventListener('loadingdone', setHeaderHeight);
  })();
</script>

        <script src="https://code.jquery.com/jquery-3.7.1.min.js" crossorigin="anonymous"></script>
        <script src="/js/dashboard.js"></script>
        {{!-- <script type="module" src="/js/modal-imagem.js"></script> --}}
        {{!-- <script defer src="/js/modal-imagem.js"></script> --}}
        <script src="/js/empresa/bcoimagem.js" defer></script>
        <script src="/js/empresa/cadastro.js" defer></script>
        <script src="/js/empresa/editecadastro.js" defer></script>
        <script src="/js/empresa/similares.js" defer></script>
        <script src="/js/rotinas/limpaSelect.js"></script>
        <script src="/js/rotinas/produto-ImageModal.js"></script>
        <script src="/js/rotinas/produto-VinculoModal.js"></script>
        <script src="/js/rotinas/produto-editModal.js"></script>
        <script src="/js/rotinas/produto-DeleteModal.js"></script>
        <script src="/js/rotinas/AcaoComDataset.js"></script>
</body>
</html>    

<!-- Modal para edi√ß√£o -->
<div id="editModal"
  style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:9999;">
  <div
    style="background:#fff; width:50%; height:auto; padding:20px; border-radius:10px; box-shadow:0 5px 10px rgba(0,0,0,0.5);">
    <h4>Editar Produto ??</h4>
    <form id="editForm">
      {{!-- <input type="text" id="editId" value=""> --}}
      <div style="margin-bottom:10px;" >
        <label>Id:</label>
        <label type="text" id="editId" name="editid" class="form-control" style="background-color: rgb(223, 138, 11);color:#121010"></label>
      </div>
      <div style="margin-bottom:10px;" >
        <label>C√≥digo:</label>
        <input type="text" id="editCodigo" name="codigo" class="form-control" style="background-color: yellow;color:#110b0b">
      </div>
      <div style="margin-bottom:10px;" >
        <label>Descri√ß√£o:</label>
        <input type="text" id="editDescricao" name="descricao" class="form-control">
      </div>
       <div style="margin-bottom:10px;" >
        <label>Complemento:</label>
        <input type="text" id="editComplemento" name="complemento" class="form-control">
      </div>
      <div style="margin-bottom:10px;">
        <label>Refer:</label>
        <input type="text" id="editRefer" name="refer" class="form-control">
      </div>
       <div style="margin-bottom:10px;background-color:transparent;margin-bottom: 6px;">
            <label style="background-color:transparent;width: 85px;padding: 5px;color:#110b0b">Fornecedor:</label>
            <select id="editFornec" name="fornecedor" style="height: 3.2vh;width:70%;margin: auto;margin-left: 6px;margin-top: 3px;">
              <option value="">Selecione:</option>
                {{#each f}}
                   <option value="{{_id}}">{{razao}} - {{marca}}</option>
                {{/each}}
        </select>
        
        {{!-- <input type="text" id="editFornec" name="fornec" class="form-control"> --}}
      </div>
      <div style="margin-bottom:10px;">
        <label>Quantidade:</label>
        <input type="number" id="editQte" name="qte" class="form-control">
      </div>
      <div style="margin-bottom:10px;">
        <label>Pre√ßo Custo:</label>
        <input type="number" step="any" id="editPrecoCusto" name="precocusto" class="form-control">
      </div>
      <div style="margin-bottom:10px;">
        <label>Pre√ßo Vista:</label>
        <input type="number" step="any" id="editPrecoVista" name="precovista" class="form-control">
      </div>
      <div style="margin-bottom:10px;">
        <label>Pre√ßo Prazo:</label>
        <input type="number" step="any" id="editPrecoPrazo" name="precoprazo" class="form-control">
      </div>
      <button type="button" class="btn btn-secondary" onclick="closeEditModal(); window.limparMenuAcoes?.();">Cancelar</button>
      <button type="submit" class="btn btn-primary">Salvar</button>
    </form>
  </div>
</div>

<!-- Modal Produto -->
<div id="modalProdutoVinculo" class="modal fade"  tabindex="-1">
   <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Produto ?</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="conteudoModalProduto">
        <!-- Conte√∫do preenchido dinamicamente via JS -->
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary btn-sm" style="background-color:#02662d;color:#ffffff" onclick="abrirModalBuscaSimilar('{{_id}}')">+ vincular</button>
      </div>
    </div>
  </div>
</div>
{{!-- Busca Similares --}}
<div id="areaBuscaSimilar" style="display:none; padding: 10px;">
  <h6>Buscar Similar para Vincular</h6>
  <input type="text" id="buscaSimilarInput1" placeholder="Buscar similar por c√≥digo ou nome" class="form-control" onkeyup="buscarSimilares(baseId)">
  <div id="resultadosSimilar1" style="margin-top:10px;"></div>
</div>
<!-- SEGUNDO BLOCO -->
<div id="modalVinculo" class="modal fade"  tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Buscar Similar para Vincular</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input id="buscaSimilarInput2" type="text" class="form-control" style="background-color: #ffffff;color: #100e0e;" placeholder="Buscar similar por c√≥digo ou nome" oninput="buscarSimilar()">
        <div id="resultadosSimilar2" class="mt-3"></div>
      </div>
    </div>
  </div>
</div>

<!-- Modal para deletar -->
<div id="deleteModal"
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,.5); justify-content:center; align-items:center; z-index:9999;">
  <div style="background:#fff; width:420px; padding:16px; border-radius:10px; box-shadow:0 5px 10px rgba(0,0,0,.3);">
    <h4>Remover produto</h4>
    <p>Tem certeza que deseja excluir o produto abaixo?</p>

    <div style="background:#f7f7f7; border:1px solid #eee; padding:8px; border-radius:6px;">
      <div><strong>ID:</strong> <span id="delId"></span></div>
      <div><strong>Descri√ß√£o:</strong> <span id="delDesc"></span></div>
    </div>

    <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:14px;">
      <button type="button" class="btn btn-secondary" onclick="closeDeleteModal();">Cancelar</button>
      <button type="button" class="btn btn-danger" id="btnConfirmDelete">Excluir</button>
    </div>
  </div>
</div>

<input id="miHiddenFile" type="file" accept="image/*" style="display:none" />
<script>
// === CORE DOS SLOTS (precisa existir ANTES de usar resetSlots) ===
const MAX_SLOTS = 7;
const slots         = Array(MAX_SLOTS).fill(null);
const originalSlots = Array(MAX_SLOTS).fill(null);
let nextIdx = 0;

function firstEmpty(){ for (let i=0;i<MAX_SLOTS;i++) if (!slots[i]) return i; return -1; }
function recompute(){ nextIdx = firstEmpty(); }

function addEmptySlot(i){
  const slot = document.createElement('div');
  slot.className = 'mi-slot empty';
  slot.dataset.idx = i;
  slot.dataset.num = i + 1;
  slot.addEventListener('click', () => {
    if (!window.$hiddenFile) return;
    $hiddenFile.dataset.targetIdx = String(i);
    $hiddenFile.value = '';
    $hiddenFile.click();
  });
  const btn = document.createElement('button');
  btn.className = 'mi-remove'; btn.title = 'Remover'; btn.textContent = '√ó';
  btn.addEventListener('click', ev => { ev.stopPropagation(); clearSlot(i); });
  slot.appendChild(btn);
  if (window.$miSlotGrid) $miSlotGrid.appendChild(slot);
  slots[i] = null;
}

function resetSlots(){
  if (!window.$miSlotGrid) return;
  $miSlotGrid.innerHTML = '';
  for (let i = 0; i < MAX_SLOTS; i++) addEmptySlot(i);
  recompute();
}

function fillSlot(i, src){
  const slot = $miSlotGrid?.children?.[i];
  if (!slot) return;
  slot.className = 'mi-slot filled';
  slot.innerHTML = '';
  const img = document.createElement('img'); img.src = src; slot.appendChild(img);
  const btn = document.createElement('button');
  btn.className = 'mi-remove'; btn.title = 'Remover'; btn.textContent = '√ó';
  btn.addEventListener('click', ev => { ev.stopPropagation(); clearSlot(i); });
  slot.appendChild(btn);
  recompute();
}

function clearSlot(i){
  const slot = $miSlotGrid?.children?.[i];
  if (!slot) return;
  slot.className = 'mi-slot empty';
  slot.innerHTML = '';
  const btn = document.createElement('button');
  btn.className = 'mi-remove'; btn.title = 'Remover'; btn.textContent = '√ó';
  btn.addEventListener('click', ev => { ev.stopPropagation(); clearSlot(i); });
  slot.appendChild(btn);
  slots[i] = null;
  recompute();
}
</script>

{{!-- <script>
/* INIT ‚Äî refer√™ncias do modal de imagem, vis√≠veis para os demais scripts */
(() => {
  window.$backdrop       = document.getElementById('modalImagem');
  window.$miSlotGrid     = document.getElementById('miSlotGrid');
  window.$miBankGrid     = document.getElementById('imgbcoImg');
  window.$miBankEmpty    = document.getElementById('miBankEmpty');
  window.$miNoBankBanner = document.getElementById('miNoBankBanner');
  window.$miSlotsTitle   = document.querySelector('.mi-slots-title');

  window.$miProdId       = document.getElementById('miProdId');
  window.$miDescricao    = document.getElementById('miDescricao');
  window.$miFornecedor   = document.getElementById('miFornecedor');
  window.$miDepartamento = document.getElementById('miDepartamento');

  window.$hiddenFile     = document.getElementById('miHiddenFile');
  window.$miReloadBank   = document.getElementById('miReloadBank');
  window.$miClearAll     = document.getElementById('miClearAll');
  window.$miClose        = document.getElementById('miClose');
  window.$btnGravar      = document.getElementById('btnGravarImagens');

  // --- menu do banco de imagens ---
  window.$miBankMenuBtn  = document.getElementById('miBankMenuBtn');
  window.$miBankMenu     = document.getElementById('miBankMenu');
  window.$miBankMenuDesc = document.getElementById('miBankMenuDesc');
  window.$miBankMenuFor  = document.getElementById('miBankMenuFor');

  // --- stubs seguros (caso os blocos de fun√ß√µes carreguem depois) ---
  window.setBankEmptyState = window.setBankEmptyState || function(flag){
    if (window.$miBankEmpty)    $miBankEmpty.style.display    = flag ? 'block' : 'none';
    if (window.$miNoBankBanner) $miNoBankBanner.style.display = flag ? 'block' : 'none';
    if (window.$miSlotsTitle)   $miSlotsTitle.textContent = flag
      ? 'Nenhuma imagem no banco ‚Äî clique nas caixas acima para buscar no computador'
      : 'Sele√ß√£o e Gravar Imagens';
  };

  window.clearBankUI = window.clearBankUI || function(showMsg = true){
    if (window.$miBankGrid) $miBankGrid.innerHTML = '';
    setBankEmptyState(!!showMsg);
  };
})();

</script> --}}
{{!-- <><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><> --}}
{{!-- MOSTRANDO E ESCONDENDO MENU LATERAL --}}
<script>
      const faixa = document.getElementById("faixaVertical");
      const menulista = document.getElementById("menulista");

      faixa.addEventListener("click", function () {
        const currentMargin = parseFloat(window.getComputedStyle(menulista).marginLeft);
        const vwToPx = vw => (vw * window.innerWidth) / 100;

        const abertoPX = 0;
        const fechadoPX = -vwToPx(10); // Agora -13vw

        if (Math.abs(currentMargin - fechadoPX) <= 1) {
          menulista.style.marginLeft = '0vw'; // Abre
        } else {
          menulista.style.marginLeft = '-10vw'; // Fecha
        }
      });
</script>
{{!-- PEGA ID LOJISTA PARA LINK FORNEC CADASTRO --}}
<script>
  function pegaIdlojista(){
    //console.log(' [ 377 pegaIdlojista]')
    let n=document.getElementById("IddoLojista");
    const link = document.getElementById("passa-cadastrofornec");
    // Atualiza o href corretamente:
    let lojistaId=n.value;
    link.href = `/fornec/cadastro/${lojistaId}`;
     const link1 = document.getElementById("passa-listafornec");
    // Atualiza o href corretamente:
    link1.href = `/fornec/listafornec/${lojistaId}`;
  }

   pegaIdlojista()
</script>
{{!-- ORDENA√á√ÉO DE COLUNS --}}
<script>
let direcaoOrdenacao = [];

function ordenarTabela(colunaIndex) {
  const tabela = document.getElementById("tabelaProdutos");
  const tbody = tabela.tBodies[0];
  const linhas = Array.from(tbody.rows);

  // Alternar dire√ß√£o
  direcaoOrdenacao[colunaIndex] = !direcaoOrdenacao[colunaIndex];
  const crescente = direcaoOrdenacao[colunaIndex];

  linhas.sort((a, b) => {
    const valA = a.cells[colunaIndex].innerText.trim();
    const valB = b.cells[colunaIndex].innerText.trim();

    const numA = parseFloat(valA.replace(",", "."));
    const numB = parseFloat(valB.replace(",", "."));
    const ambosNumeros = !isNaN(numA) && !isNaN(numB);

    if (ambosNumeros) {
      return crescente ? numA - numB : numB - numA;
    } else {
      return crescente
        ? valA.localeCompare(valB)
        : valB.localeCompare(valA);
    }
  });

  linhas.forEach(row => tbody.appendChild(row));
}
</script>
{{!-- buscaSimilarInput2 --}}
<script>
window.addEventListener("DOMContentLoaded", () => {
  const inputBuscar = document.getElementById("buscaSimilarInput2");

  if (!inputBuscar) return;

  inputBuscar.addEventListener("input", async (e) => {
    console.log(' [ 617 produtos .handlebars]')
    const termo = e.target.value.trim();
    if (termo.length < 2 || !produtoIdBaseSelecionado) return;

    try {
      const resposta = await fetch(`/simiproduto/buscar?termo=${encodeURIComponent(termo)}&baseId=${produtoIdBaseSelecionado}`);
      const similares = await resposta.json();

      const lista = document.getElementById("resultadosSimilar2");
      lista.innerHTML = "";

      if (!similares.length) {
        lista.innerHTML = '<div class="text-muted">Nenhum resultado encontrado</div>';
        return;
      }

      similares.forEach(sim => {
        const li = document.createElement("li");
        li.className = "list-group-item d-flex justify-content-between align-items-center";
        li.innerHTML = `
          <div>
            <strong>${sim.codigo}</strong> - ${sim.descricao} (R$ ${parseFloat(sim.precovista?.$numberDecimal || '0').toFixed(2)})
          </div>
          <button class="btn btn-sm btn-success" onclick="vincularSimilar('${produtoIdBaseSelecionado}', '${sim._id}')">Vincular</button>
        `;
        lista.appendChild(li);
      });
    } catch (err) {
      console.error("Erro na busca de similares:", err);
    }
  });
});
</script>
{{!-- executarAcao(acao, id, codigo, descricao,fornecedor) --}}
<script>
  function executarAcao(acao, id, descricao,fornecedor,departamento) {
        const row = document.querySelector(`[data-id='${id}']`);
        const tableRows = document.querySelectorAll("tr");

        // limpa os destaques anteriores
        tableRows.forEach(r => r.classList.remove("edit-row", "delete-row"));
        console.log('');
        const produtoId=id;
        const departamentoNome=departamento;
        switch (acao) {
          case "vincular":
            console.log(' [ 479 ] executarAcao',id)
            abrirModalVinculoProduto(id);
            window.abrirModalVinculoProduto = abrirModalVinculoProduto;
            break;
          case "imagens":
             window.abrirModalImagem({
                produtoId,
                descricao,
                fornecedor,
                departamento: departamentoNome
              });
              break;
          case "editar":
            row?.classList.add("edit-row");
            openEditModal(id);
            window.openEditModal = openEditModal;
            break;
          case "deletar":
             row?.classList.add("delete-row");
             openDeleteModal(id, descricao);
             window.openDeleteModal = openDeleteModal;
             break;
        }
  }

  //abrirModalImagens para selecionar a imaagem a ser gravada
  function abrirModalImagens(descricao, fornecedor, { produtoId, departamentoNome }) {
        console.log(' [ 981 -abrirModalImagens]')
        window.abrirModalImagem({
          produtoId,
          descricao,
          fornecedor,
          departamento: departamentoNome
        });
  }
</script>
{{!-- openCadastroModal --}}
<script>
  function openCadastroModal(){
      document.getElementById("cadastroProdutoModal").style.display="block";
  }  
</script>
{{!-- modalContent-SetorSecao --}}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const spans = document.querySelectorAll(".departamento-click");
    const modal = document.getElementById("modalInfoSetorSecao");
    const modalContent = document.getElementById("modalContentSetorSecao");

    spans.forEach(span => {
      span.addEventListener("click", function (e) {
        const index = parseInt(this.dataset.index);

        // Obtem dados do JS pr√©-carregado
        const dados = window.todosSetoresSecoes?.[index];
        if (!dados) return;

        let html = "";
        if (dados.setores?.length) {
          html += "<strong>Setores:</strong><ul>";
          dados.setores.forEach(s => html += `<li>${s}</li>`);
          html += "</ul>";
        }

        if (dados.secoes?.length) {
          html += "<strong>Se√ß√µes:</strong><ul>";
          dados.secoes.forEach(s => html += `<li>${s}</li>`);
          html += "</ul>";
        }

        modalContent.innerHTML = html;

        // Posiciona o modal
        const rect = this.getBoundingClientRect();
        modal.style.left = `${rect.left + window.scrollX}px`;
        modal.style.top = `${rect.top + window.scrollY - modal.offsetHeight - 10}px`;
        modal.style.display = "block";
      });
    });

    // Esconde o modal ao clicar fora
    document.addEventListener("click", function (e) {
      if (!e.target.classList.contains("departamento-click") &&
          !modal.contains(e.target)) {
        modal.style.display = "none";
      }
    });
  });
</script>
 {{!-- FECHA CADASTROMODAL --}}
<script>
  function closeCadastroModal(){
     document.getElementById("cadastroProdutoModal").style.display="none"
  }
</script>
{{!-- /** ====== BLOCO 1 ‚Äî BUSCA NO COMPUTADOR (com filtro gen√©rico) ====== */ --}}
{{!-- <script>
        /** ====== BLOCO 1 ‚Äî BUSCA NO COMPUTADOR (com filtro gen√©rico) ====== */
        $hiddenFile?.addEventListener('change', (ev)=>{
                  const APLICAR_FILTRO_UPLOAD = true; 
                  const file = ev.target.files?.[0];
                  const idx  = Number(ev.target.dataset.targetIdx ?? '-1');
                  if (!file || idx < 0) return;

                  if (APLICAR_FILTRO_UPLOAD && $miDescricao?.value){
                  if (!matchDescricaoTexto(file.name, $miDescricao.value)){
                      alert('A imagem escolhida n√£o parece do mesmo produto (pelo nome do arquivo).');
                      ev.target.value = '';
                      return;
                  }
                  }

                  const reader = new FileReader();
                  reader.onload = ()=>{ slots[idx] = { type:'file', file }; fillSlot(idx, reader.result); };
                  reader.readAsDataURL(file);
        });
</script> --}}
{{!-- // BLOCO 2 ‚Äî CARREGA AS IMAGENS J√Å VINCULADAS (por produtoId) + ABRIR MODAL --}}
{{!-- <script>
    // BLOCO 2 ‚Äî Carregar vinculadas e abrir
    async function carregarImagensDoProduto(produtoId, pageurls = []){
          originalSlots.fill(null);

          if (!produtoId) return;

          let lista = [];
          try {
              // ajuste a rota se a sua for diferente
              const r = await fetch(`/gravafoto/produtoImagem/buscar/${encodeURIComponent(produtoId)}`, { cache: 'no-store' });
              if (r.ok) lista = await r.json();
              console.log('');
              console.log(lista);
              console.log('');
          } catch (e) {
            console.warn('[carregarImagensDoProduto] falhou ao buscar por ID:', e);
            return;
          }

          console.log(lista)

          // 1) A API pode devolver o PRODUTO com 'pageurls' OU uma lista de imagens.
          //    Detecta e normaliza para [{url, key}].
          let docs = [];

          // caso 1: veio um produto com pageurls
          if (Array.isArray(lista) && lista.length && Array.isArray(lista[0].pageurls)) {
            docs = lista[0].pageurls
              .map(u => ({ url: String(u || '').trim(), key: null }))
              .filter(d => !!d.url);

          // caso 2: veio uma lista de registros de imagem
          } else {
            docs = (Array.isArray(lista) ? lista : [])
              .map(x => ({
                url: x.imagemUrl || x.url || '',
                key: x.shortkey || x.key || x._id || ''
              }))
              .filter(x => !!x.url);
          }

          console.log('');
          console.log('=> ',docs);
          console.log('');
          // 2) mescla 'pageurls' recebidos por par√¢metro (se voc√™ passar da tela)
          if (Array.isArray(pageurls)) {
            pageurls.forEach(u => {
              const s = String(u || '').trim();   // <‚Äî aqui √© String, n√£o string
              if (!s) return;
              if (!docs.some(d => d.url === s)) docs.push({ url: s, key: null });
                          });
          }


          if (!$miSlotGrid || !$miSlotGrid.children.length) resetSlots();
 
            for (const it of docs.slice(0, MAX_SLOTS)) {
                  const i = firstEmpty();
                  if (i === -1) break;

                  console.log('it.url =>', it.url);

                  slots[i]         = { type:'bank', url: it.url, key: it.key, origin:'existing' };
                  originalSlots[i] = { url: it.url, key: it.key };
                  fillSlot(i, it.url);   // usa sua fun√ß√£o j√° existente
            }
             

    }


    async function _abrirModalImagemImpl({ produtoId='', descricao='', fornecedor='', departamento='', pagerUrls=[] } = {}){
                console.log('[IMG] abrirModalImagemImpl()', { produtoId, descricao, fornecedor, departamento });
                if (window.acoCloseMenus) window.acoCloseMenus();

  // (se quiser) garante que nenhum select fique ‚Äúpreso‚Äù
  // __resetSelectIfNeeded?.();

  $miProdId.value       = String(produtoId||'');
  $miDescricao.value    = String(descricao||'');
  $miFornecedor.value   = String(fornecedor||'');
  $miDepartamento.value = String(departamento||'');

  clearBankUI(true);

  if (typeof resetSlots === 'function') resetSlots();
  else if (window.$miSlotGrid) $miSlotGrid.innerHTML = '';

  originalSlots.fill(null);

  try {
    await carregarImagensDoProduto(produtoId);
    console.log('[IMG] imagens vinculadas carregadas');
  } catch (e) {
    console.error('[IMG] erro carregarImagensDoProduto', e);
  }

  $backdrop.classList.add('show');
  $backdrop.setAttribute('aria-hidden','false');
}
window.abrirModalImagem = _abrirModalImagemImpl; // mant√©m global


               
</script> --}}
{{!-- <script>
    // garante refer√™ncias j√° criadas ($backdrop, resetSlots, etc.)
    function __limparEstadoDoModal(){
      try { if (typeof resetSlots === 'function') resetSlots(); } catch(e){}
      try { originalSlots.fill(null); } catch(e){}
      try { if ($miBankGrid) $miBankGrid.innerHTML = ''; } catch(e){}
      try { if (typeof setBankEmptyState === 'function') setBankEmptyState(true); } catch(e){}
      try { __lastBankCriteria = { descricao:'', fornecedor:'' }; } catch(e){}
      try { if ($miBankMenu){ $miBankMenu.classList.remove('show'); $miBankMenu.setAttribute('hidden',''); } } catch(e){}
      try { if ($hiddenFile){ $hiddenFile.value=''; if ($hiddenFile.dataset) delete $hiddenFile.dataset.targetIdx; } } catch(e){}
    }

    function __fecharModal(){
      if (!$backdrop) return;
      $backdrop.classList.remove('show');
      $backdrop.setAttribute('aria-hidden','true');
      __limparEstadoDoModal();

      window.limparMenuAcoes?.();
    }

    // deixa dispon√≠vel mesmo se os listeners forem definidos antes
    window.__fecharModal = __fecharModal;
</script>
{{!-- // BLOCO 3 ‚Äî BUSCA NO BANCO DE IMAGENS --}}
<script>
    // BLOCO 3 ‚Äî Banco de imagens (filtro leve por descri√ß√£o)
    async function carregarBcoImagens({descricao, fornecedor, departamento}){
        __lastBankCriteria = { descricao: descricao || '', fornecedor: fornecedor || '' };

        $miBankGrid.innerHTML = '';
        setBankEmptyState(false);

        try{
          const q = new URLSearchParams({
            descricao: descricao || '',
           // fornecedor: fornecedor || '',
           // departamento: departamento || ''
          }).toString();

          console.log('');
          console.log(' [1484] valor de q',q)
          console.log('');
          console.log('',descricao)
          const r = await fetch(`/gravafoto/buscarBcoImg?${q}`, { cache: 'no-store' });
          if (!r.ok) throw new Error('Falha ao buscar banco de imagens');
          //console.log(' Retorno da consulta / Gravafoto/buscarBcoImg?',r.json())
          let lista = await r.json();
          if (!Array.isArray(lista)) lista = [];
          console.log( 'LISTA => ',lista) 
          // filtro leve por descri√ß√£o do produto
          if (descricao) lista = lista.filter(it => 
                  matchDescricaoTexto(
                    it?.produtoNome||it?.url||'', descricao
                  )
            );

          if (!lista.length){ setBankEmptyState(true); return; }

          $miBankGrid.innerHTML = '';              // garante limpar antes
          setBankEmptyState(false); 

          console.log('lista ',lista.length)

          for (const it of lista){
            const card = document.createElement('div'); 
            card.className='mi-thumb';
            const img  = document.createElement('img'); 
            img.loading='lazy';
            img.src = it.url || it.imagemUrl; 
            card.appendChild(img);

            card.addEventListener('click', ()=>{
              const i = firstEmpty(); 
              if (i===-1){ alert('Limite de 7 imagens.'); return; }

              slots[i] = { type:'bank', url: it.url, key: it.key||null, origin:'bank' };
              fillSlot(i, it.url);
            });
            console.log('');

            console.log('')
            console.log('',card);
            console.log(firstEmpty());
            console.log('')
            $miBankGrid.appendChild(card);
          }
        }catch(e){
          console.error(e);
          setBankEmptyState(true);
        }
    }

    // Recarregar usa o √∫ltimo crit√©rio (se existir), sen√£o pega os inputs
    $miReloadBank?.addEventListener('click', ()=>{
      const hasLast = (__lastBankCriteria.descricao || __lastBankCriteria.fornecedor);
      const crit = hasLast
        ? { ...__lastBankCriteria, departamento: '' }
        : { descricao: $miDescricao.value || '', fornecedor: $miFornecedor.value || '', departamento: $miDepartamento.value || '' };
      carregarBcoImagens(crit);
    });

    function openBankMenu(){
      if(!$miBankMenu || !$miBankMenuBtn) return;

      // garante que o menu √© filho do bloco da esquerda do rodap√©
      const anchorWrap = $miBankMenuBtn.closest('.mi-footer-left');
      if (anchorWrap && $miBankMenu.parentElement !== anchorWrap) {
        anchorWrap.appendChild($miBankMenu);
      }

      // for√ßa posi√ß√£o fixa no lado esquerdo
      $miBankMenu.style.left   = '0';
      $miBankMenu.style.right  = 'auto';
      $miBankMenu.style.bottom = '56px';

      $miBankMenu.classList.add('show');
      $miBankMenu.removeAttribute('hidden');
    }

    function closeBankMenu(){
      if(!$miBankMenu) return;
      $miBankMenu.classList.remove('show');
      $miBankMenu.setAttribute('hidden','');
    }

    $miBankMenuBtn?.addEventListener('click', (e)=>{
      e.stopPropagation();
      if ($miBankMenu.classList.contains('show')) closeBankMenu();
      else openBankMenu();
    });

    // fecha menu ao clicar fora
    document.addEventListener('click', (e)=>{
      if (!$miBankMenu?.classList.contains('show')) return;
      const t = e.target;
      if (!$miBankMenu.contains(t) && !$miBankMenuBtn.contains(t)) closeBankMenu();
    });

    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeBankMenu(); });

    // a√ß√µes do menu
    $miBankMenuDesc?.addEventListener('click', ()=>{
      closeBankMenu();
      __lastBankCriteria = { descricao: $miDescricao.value || '', fornecedor: '' };
      carregarBcoImagens({ ...__lastBankCriteria, departamento: '' });
    });
    $miBankMenuFor?.addEventListener('click', ()=>{
      closeBankMenu();
      __lastBankCriteria = { descricao: '', fornecedor: $miFornecedor.value || '' };
      carregarBcoImagens({ ...__lastBankCriteria, departamento: '' });
    });


    // atalhos existentes (mant√©m)
    $miClearAll?.addEventListener('click', resetSlots);

    // bot√£o X (fechar)
    $miClose?.addEventListener('click', ()=>window.__fecharModal?.());
    

    // clique no fundo do backdrop
    $backdrop?.addEventListener('click', (ev)=>{ if (ev.target === $backdrop) window.__fecharModal?.(); });

    // ESC
   window.addEventListener('keydown', (ev)=>{ if (ev.key === 'Escape' && $backdrop.classList.contains('show')) window.__fecharModal?.(); });
  




</script>
{{!-- // BLOCO 4 ‚Äî Gravar imagens (usa suas fun√ß√µes existentes) --}}
<script>
    // BLOCO 4 ‚Äî Gravar imagens (usa suas fun√ß√µes existentes)
    $btnGravar?.addEventListener('click', async ()=>{
            const temAlgo = slots.some(Boolean);
            if (!temAlgo){ alert('Nenhuma imagem selecionada.'); return; }

            // --- diffs (igual ao que voc√™ j√° vinha usando) ---
            const sameRef = (a,b)=> !!(a&&b) && (
                (a.key && b.key && a.key===b.key) ||
                (!a.key && !b.key && a.url && b.url && a.url===b.url)
            );

            const removed=[], refsAdd=[], uploads=[];
            for (let i=0;i<MAX_SLOTS;i++){
                const orig = originalSlots[i];
                const cur  = slots[i];
                if (!orig && !cur) continue;
                if (!orig && cur){ (cur.type==='file' ? uploads : refsAdd).push({idx:i, ...cur}); continue; }
                if (orig && !cur){ removed.push({idx:i, ...orig}); continue; }
                if (cur.type==='file'){ removed.push({idx:i, ...orig}); uploads.push({idx:i, ...cur}); }
                else if (cur.type==='bank'){ sameRef(orig,cur) ? 0 : (removed.push({idx:i, ...orig}), refsAdd.push({idx:i, ...cur})); }
            }

            try{
                // aqui voc√™ chama suas fun√ß√µes j√° existentes:
                await salvarImagensCompat({
                produtoId:    $miProdId.value,
                descricao:    $miDescricao.value,
                fornecedor:   $miFornecedor.value,
                departamento: $miDepartamento.value,
                refsAdd, uploads, removed,
                order: slots.map((s,i)=> s ? (s.type==='bank'?{type:'bank',idx:i,key:s.key}:{type:'file',idx:i,filename:s.file?.name||null}) : null)
                }, slots);

                alert('Imagens gravadas com sucesso.');
                //$backdrop.classList.remove('show');
                //$backdrop.setAttribute('aria-hidden','true');
                window.__fecharModal();
            }catch(e){
                console.error(e); alert('Erro ao gravar imagens. Veja o console.');
            }
    });
</script> --}}

<script>
function pad2(n){ return String(n+1).padStart(2,'0'); }

/**
 * 1) Para cada upload: pega presigned, faz PUT e depois salva JSON
 * 2) Para cada ref nova: salva JSON direto
 * (Removed: deixamos logado por enquanto; plugamos quando houver rota)
 */
async function salvarImagensCompat({ produtoId, descricao, fornecedor, departamento, refsAdd, uploads, removed, order },slotsRef){
        // 1) uploads (presigned + PUT + salvar)
        for (const u of uploads){
                const idx  = u.idx;
                const s    = slotsRef[idx];
                const file = s?.file;
                if (!file) continue;

                // 1.1 pega presigned
                const qs = new URLSearchParams({
                  filename: file.name,
                  filetype: file.type || 'image/png',
                  ordem: pad2(idx)
                });
                const r = await fetch(`/gravafoto/getpresignedurl?${qs.toString()}`, { cache: 'no-store' });
                console.log('R =====',r)
                if (!r.ok) throw new Error('Falha ao obter URL de upload');
                const { uploadUrl, key } = await r.json();

                // 1.2 envia para o Space
                const up = await fetch(uploadUrl, {
                      method: 'PUT',
                      body: file,
                      headers: {
                        'Content-Type': file.type,   // deve bater com filetype usado na assinatura
                        'x-amz-acl': 'public-read'   // mant√©m p√∫blico ao salvar
                  }
                });                

                if (!up.ok) throw new Error('Falha ao enviar arquivo para o Space');

                const publicUrl = uploadUrl.split('?')[0];

                // 1.3 grava registro no seu banco
                await postSalvarImagem({
                  produtoId, descricao, fornecedor, departamento,
                  imagemUrl: publicUrl,
                  shortkey:  key,
                  mimeType:  file.type || 'image/png',
                  size:      file.size,
                  ordem:     pad2(idx)
                });
        }

        // 2) refs novas (n√£o precisam de upload)
        for (const r of refsAdd){
          await postSalvarImagem({
            produtoId, descricao, fornecedor, departamento,
            imagemUrl: r.url,
            shortkey:  r.key,
            mimeType:  'image/*',
            size:      0,
            ordem:     pad2(r.idx)
          });
        }

        // 3) removidos (se tiver rota depois plugamos aqui)
        if (removed.length){
          console.warn('[remove] pendente de integrar no servidor:', removed);
        }

        // 4) ordem final (se voc√™ quiser aplicar do lado do servidor)
        console.info('[order] estado final pedido:', order);
}

/** POST JSON no endpoint que voc√™ j√° usa */
async function postSalvarImagem({
  produtoId, descricao, fornecedor, departamento,
  imagemUrl, shortkey, mimeType, size, ordem
}){
  const body = {
    codigoId:     produtoId,
    produtoNome:  descricao,
    fornecedor:   fornecedor,
    departamento: departamento,
    imagemUrl,
    shortkey,
    mimeType,
    size,
    ordem
  };

  const res = await fetch('/gravafoto/imagem/salvar', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });
  if (!res.ok) {
    const t = await res.text().catch(()=> '');
    throw new Error(`Falha ao gravar imagens: ${res.status} ${t}`);
  }
  return res.json().catch(()=> ({}));
}

</script>

<script>
(function initSlotGrid() {
  const grid = document.getElementById("miSlotGrid");
  if (!grid) return;

  const TOTAL_SLOTS = 7;
  grid.innerHTML = "";

  for (let i = 1; i <= TOTAL_SLOTS; i++) {
    const slot = document.createElement("div");
    slot.className = "mi-slot";
    slot.dataset.index = i;

    const img = document.createElement("img");
    img.className = "mi-preview";
    img.id = `preview_${i}`;
    img.style.width = "100%";
    img.style.height = "100%";
    img.style.objectFit = "contain";
    img.style.display = "none";

    const span = document.createElement("span");
    span.textContent = "Clique aqui para pegar a foto no computador";
    span.className = "mi-label";

    const input = document.createElement("input");
    input.type = "file";
    input.accept = "image/*";
    input.style.display = "none";

    // clique no slot abre seletor
    slot.addEventListener("click", () => {
      input.click();
    });

    // ao escolher a imagem -> mostrar preview
    input.addEventListener("change", () => {
      const file = input.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        img.src = e.target.result;
        img.style.display = "block";
        span.style.display = "none";
      };
      reader.readAsDataURL(file);
    });

    slot.appendChild(img);
    slot.appendChild(span);
    slot.appendChild(input);
    grid.appendChild(slot);
  }
})();
</script>
{{!-- 1) Ao terminar o INIT, garanta que os slots existam --}}
<script>
// üîó 1) Ao terminar o INIT, garanta que os slots existam
document.addEventListener('DOMContentLoaded', () => {
  if (window.$miSlotGrid) resetSlots();
});
</script>
{{!-- Listener do input oculto: transfere a imagem escolhida para o slot clicado --}}
<script>
// üñºÔ∏è 2) Listener do input oculto: transfere a imagem escolhida para o slot clicado
(() => {
  if (!window.$hiddenFile) return;

  $hiddenFile.addEventListener('change', function () {
    const idx  = parseInt(this.dataset.targetIdx || '-1', 10);
    const file = this.files && this.files[0];
    if (idx < 0 || !file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
      // preenche visualmente o slot
      fillSlot(idx, e.target.result);

      // registra no estado (se voc√™ usa depois para upload)
      slots[idx] = { type: 'file', file };

      recompute();
    };
    reader.readAsDataURL(file);

    // permite escolher o MESMO arquivo novamente no futuro
    this.value = '';
  });
})();
</script>

<script>
// üßπ 3) Bot√£o "Limpar sele√ß√£o" reaproveitando o que voc√™ j√° tem
(() => {
  if (!window.$miClearAll) return;
  $miClearAll.addEventListener('click', () => {
    resetSlots();
    // zera o estado tamb√©m
    for (let i = 0; i < MAX_SLOTS; i++) slots[i] = null;
  });
})();
</script>
<script>
// === helpers globais (uma vez s√≥) ===
//(function(){
  (function(){
  if (!window.__norm) {
    window.__norm = function(s){
      return String(s || '')
        .normalize('NFD')
        .replace(/\p{Diacritic}/gu, '')
        .toLowerCase()
        .trim();
    };
  }

 if (!window.__STOP) {
    window.__STOP = new Set(['de','da','do','das','dos','mm','cm','m','x','para','e']);
  }

  if (!window.matchDescricaoTexto) {
    window.matchDescricaoTexto = function(texto, consulta){
      const A = __norm(texto).split(/[^a-z0-9]+/g).filter(t => t && !__STOP.has(t) && !/^\d+$/.test(t));
      const B = __norm(consulta).split(/[^a-z0-9]+/g).filter(t => t && !__STOP.has(t) && !/^\d+$/.test(t));
      if (!B.length) return true;

      let hits = 0;
      for (const t of B){
        if (A.some(a => a.includes(t) || t.includes(a))) hits++;
      }
      const need = Math.min(2, Math.ceil(B.length / 2));
      return hits >= need;
    };
  }
})();
</script>

